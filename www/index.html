<!DOCTYPE html>
<html>

<head>
    <title>CrazedCoding.com</title>
    <meta charset="utf-8" name="viewport" content="width=device-width, initial-scale=1.0">

    <link rel="icon" type="image/x-icon" href="favicon.ico">

    <link rel="stylesheet" href="css/bootstrap.min.css" />
    <link rel="stylesheet" href="css/style.css" />

    <link rel="stylesheet" href="codemirror/lib/codemirror.css">
    <link rel="stylesheet" href="codemirror/theme/the-matrix.css">
    <script src="codemirror/lib/codemirror.js"></script>
    <script src="codemirror/mode/xml/xml.js"></script>
    <script src="codemirror/mode/javascript/javascript.js"></script>
    <script src="codemirror/mode/clike/clike.js"></script>
    <script src="codemirror/addon/display/autorefresh.js"></script>

    <script type="text/javascript" src="js/jquery.min.js"></script>
    <script type="text/javascript" src="js/bootstrap.bundle.min.js"></script>
    <script type="text/javascript" src="js/protobuf.js"></script>
    <script type="text/javascript" src="js/html2canvas.min.js"></script>
</head>

<body>
    <div id="menu-backgrond" class="topnav-background" style="display:none;"></div>
    <div id="menu" class="topnav" style="display:none !important;">
        <a id="home_button" onclick="state.collapse_nav();" style="float: left;" href="#home">CrazedCoding.com</a>
        <a id="browse_button" onclick="state.collapse_nav();" href="#browse">Browse</a>
        <a id="edit_button" onclick="state.collapse_nav();" href="#edit">Edit</a>
        <a id="create_button" onclick="state.collapse_nav();" href="#create">Create</a>
        <a id="profile_button" onclick="state.collapse_nav();" class="logged_in_content" style="display: none"
            href="#profile">Profile</a>
        <a id="login_button" onclick="state.collapse_nav();" class="logged_out_content" href="#login">Login</a>
        <a id="signup_button" onclick="state.collapse_nav();" class="logged_out_content" style="display: none"
            href="#signup">Sign Up</a>
        <a id="logout_button" onclick="state.collapse_nav();" class="logged_in_content" style="display: none"
            href="#logout">Log Out</a>
        <a id="reset_button" style="display: none;" onclick="state.collapse_nav();" href="#reset">Reset</a>
        <a id="request_button" style="display: none;" onclick="state.collapse_nav();" href="#request">Request</a>
        <a href="javascript:void(0);" class="icon" onclick="state.toggle_nav()">
            <div class=" bar"></div>
            <div class="bar"></div>
            <div class="bar"></div>
        </a>
    </div>
    <div id="popovers" style="height: 100%; width: 100%; position: absolute; text-align: center;"></div>
    <div id="belownav" style="display: none;">
        //{{reconnect.html}}
        //{{reset.html}}
        //{{policy.html}}
        //{{logout.html}}
        //{{delete_algorithm.html}}
        //{{request.html}}
        //{{home.html}}
        //{{browse.html}}
        //{{edit.html}}
        //{{create.html}}
        //{{delete_account.html}}
        //{{profile.html}}
        //{{login.html}}
        //{{signup.html}}
    </div>
    <iframe sandbox="allow-scripts allow-same-origin" allow="microphone"
        style="border:1px solid #fff; width: 100%; height: 100%;" src="canvas.html?algorithm=background"
        id="background_iframe"></iframe>
    <script>
        var iframe = null;

        //Protocol Buffer Types
        var Message = null;
        var User = null;
        var Captcha = null;

        const pages = {
            RECONNECT: "#reconnect",
            PROCESSING: "#processing",
            CLIENT_ERROR: "#client_error",
            SERVER_ERROR: "#server_error",
            RESET: "#reset",
            POLICY: "#policy",
            LOGOUT: "#logout",
            DELETE_ALGORITHM: "#delete_algorithm",
            REQUEST: "#request",
            HOME: "#home",
            BROWSE: "#browse",
            EDIT: "#edit",
            CREATE: "#create",
            DELETE_ACCOUNT: "#delete_account",
            PROFILE: "#profile",
            LOGIN: "#login",
            SIGNUP: "#signup",
        }

        function Video() {
            this.data = null;
            this.extension = null;
            this.name = "";
        }

        function GlobalState() {
            this.logged_in = false;
            this.user_name = "";
            this.user_email = ""
            this.user_password = ""
            this.websocket = null;
            this.protocol = null;
            this.last_captcha = null;
            this.current_page = null;
            this.local_file = null;
            this.video = new Video();
            this.result = null;
            this.page_history = []
            this.first_connection = true;
            this.page_transitions = [];
            this.deleting_algorithm = false;
            this.deleting_account = false;
            this.pipeline = {
                contexts: [],
                programs: [],
                stages: []
            };
            this.context_codemirrors = [];
            this.program_codemirrors = [];
            this.stage_codemirrors = [];

            this.codemirrors = []

            this.popover_counter = 0;
            this.popovers = [];
            this.first_connection = true;
        }
        var Auth, Image, Video, Sound, Person, CommentMesssage, MetaAlgorithm,
            Query, Catalog, Vote, OpenGLDimension, OpenGLUniform, OpenGLContext,
            OpenGLProgram, OpenGLStage, OpenGLPipeline, AlgorithmState,
            AlgorithmMessage, Custom, ErrorMessage, Captcha, Message;

        var default_opengl_dimension, default_algorithm_context, default_algorithm_uniform,
            default_algorithm_program, default_algorithm_stage, default_create_algorithm;

        GlobalState.prototype.wait_for_proto_and_connect = function (most_likely_page) {
            this.protocol = protobuf.parse(`
            //{{proto/messages.proto}}
            `).root;
            OpenGLDimension = this.protocol.lookupType("messages.OpenGLDimension");
            OpenGLUniform = this.protocol.lookupType("messages.OpenGLUniform");
            OpenGLContext = this.protocol.lookupType("messages.OpenGLContext");
            OpenGLProgram = this.protocol.lookupType("messages.OpenGLProgram");
            OpenGLStage = this.protocol.lookupType("messages.OpenGLStage");
            // OpenGLPipeline = this.protocol.lookupType("messages.OpenGLPipeline");
            AlgorithmState = this.protocol.lookupType("messages.AlgorithmState");
            AlgorithmMessage = this.protocol.lookupType("messages.Algorithm");
            // Custom = this.protocol.lookupType("messages.Custom");
            // ErrorMessage = this.protocol.lookupType("messages.Error");
            // Captcha = this.protocol.lookupType("messages.Captcha");
            Message = this.protocol.lookupType("messages.Message");



            default_opengl_dimension = {
                type: OpenGLDimension.Type.SCREEN_SIZE,
                value: "//Retrun the floating point value of a javascript evaulation here. It is re-evaluated every frame."
            }

            default_algorithm_context = {
                name: "",
                width: JSON.parse(JSON.stringify(default_opengl_dimension)),
                height: JSON.parse(JSON.stringify(default_opengl_dimension)),
                depth_test: false
            }

            default_algorithm_uniform = {
                type: OpenGLUniform.Type.FLOAT,
                name: "",
                value: "return 0;"
            }
            default_algorithm_program = {
                name: "",
                uniforms: [],
                fragment:

                    "precision highp float;\n" +
                    "precision highp int;\n" +
                    "\n" +
                    "#define UNIFORM_INSERTION_POINT\n" +
                    "\n" +
                    "varying vec2 vPosition;\n" +
                    "        \n" +
                    "void main()\n" +
                    "{\n" +
                    "    vec2 uv = vPosition;\n" +
                    "    gl_FragColor.rgb = vec3(sin(uv+time), sin(time));\n" +
                    "    gl_FragColor.a = 1.0;\n" +
                    "}",
                vertex:

                    "precision highp float;\n" +
                    "precision highp int;\n" +
                    "\n" +
                    "#define UNIFORM_INSERTION_POINT\n" +
                    "\n" +
                    "attribute highp vec4 vertex; \n" +
                    "\n" +
                    "varying vec2 vPosition;\n" +
                    "void main(void) {\n" +
                    "    vPosition = vertex.xy;\n" +
                    "    gl_Position = vec4(vPosition*2.-1., 0., 1.);\n" +
                    "}"
            }

            default_algorithm_stage = {
                name: "",
                type: OpenGLStage.Type.SHADER,
                context: "",
                program: "",
                vertices: "return []; // Return vertices array.",
                indices: "return []; //Return indices to vertices array."
            }

            $.ajax({
                type: 'GET',
                url: 'algorithms/default.json',
                success: function (data) {
                    default_create_algorithm = data;
                    this.show_page(pages.PROCESSING, "Connecting...", "Please be patient.", false);
                    this.connect();
                    state.refresh_content("#" + most_likely_page);
                }.bind(this),
                async: false
            });
        }
        GlobalState.prototype.reconnect = function () {
            this.show_page(pages.PROCESSING, "Reconnecting...", "Please be patient.", false);
            this.connect();
        }
        GlobalState.prototype.connect = function () {
            this.websocket = new WebSocket("wss://" + window.location.hostname);

            this.websocket.binaryType = "arraybuffer";
            this.websocket.onclose = function (event) {
                this.logged_in = false;
                //$(".connected_content out-of-sight").css("visibility", "hidden");
                this.show_logged_out_content();
                var this_function = function (popover) {
                    this.show_page(pages.RECONNECT);
                }.bind(this);
                this.show_page(pages.CLIENT_ERROR, "Connection closed. Code: " + event.code, "If you were logged in, you are now logged out.", true, this_function)
            }.bind(this)
            this.websocket.onmessage = function (event) {
                try {
                    var decoded = Message.decode(new Uint8Array(event.data));
                    this.handle_message(decoded);
                }
                catch (e) {
                    this.show_page(pages.CLIENT_ERROR, "Error! Could not decode server response", e + "", true);
                    console.error(e);
                }
            }.bind(this);
            this.websocket.onopen = function () {
                this.show_logged_out_content();
                if (window.location.hash != pages.EDIT &&
                    window.location.hash != pages.CREATE)
                    this.hide_popovers();
                if (window.location.hash == pages.RECONNECT
                    || window.location.hash == pages.LOGOUT
                    || window.location.hash == pages.DELETE_ACCOUNT
                    || window.location.hash == pages.PROFILE
                    || (window.location.hash == pages.RESET && !this.first_connection)
                    || !window.location.hash) {
                    document.getElementById(pages.HOME.substring(1) + "_button").click();
                }
                else {
                    document.getElementById(window.location.hash.substring(1) + "_button").click();
                }
                $("#belownav").fadeIn(1000.);


                //Read URI
                var user_query_param = getQueryVariable("user");
                var code_query_param = getQueryVariable("code");

                if (window.location.hash == pages.RESET) {
                    if (this.first_connection && user_query_param && code_query_param) {
                        state.user_name = user_query_param;
                        $("#hidden_username1").val(user_query_param);
                        $("#hidden_username2").val(user_query_param);
                        state.show_page(pages.PROCESSING, "Validatings...", "Please be patient.", false);
                        state.send(Message.encode({
                            type: Message.Type.VALIDATE,
                            auth: {
                                user: user_query_param,
                                email: "",
                                password: "",
                            },
                            captcha: {
                                key: code_query_param
                            }
                        }).finish())
                        routed = true;
                        window.history.replaceState({}, document.title, removeURLParameter(removeURLParameter(window.location.href, "user"), "code"));
                    }
                    else {
                        this.show_page(pages.CLIENT_ERROR, "Error! Invalid reset token.", "Please use the password reset functionality to change your password.", true, function (popover) {
                            this.show_page(pages.HOME);
                        }.bind(this));
                    }
                }
                if (this.first_connection) {
                    //    this.handle_navigation();
                    this.first_connection = false;
                    this.refresh_content(window.location.hash);
                }
            }.bind(this);

            //$(".disconnected_content out-of-sight").css("visibility", "visible");
        }

        GlobalState.prototype.send = function (encoded, request_updates = false) {
            this.websocket.send(encoded.length);

            if (request_updates)
                this.websocket.send(1);
            else
                this.websocket.send(0);
            var fragment_size = 1024 * 512;
            for (var i = 0; i < encoded.length; i += fragment_size) {
                var start = i;
                var end = i + fragment_size;
                this.websocket.send(encoded.subarray(start, end));
            }
        }
        GlobalState.prototype.refresh_captchas = function () {
            if (this.websocket && this.websocket.readyState == WebSocket.OPEN)
                this.send(Message.encode({ type: Message.Type.CAPTCHA }).finish());
        }

        GlobalState.prototype.handle_message = function (proto) {
            console.log(proto);

            if (proto.type == Message.Type.LOGIN) {
                this.user_name = proto.auth.user;
                this.user_email = proto.auth.email;
                //this.user_password = proto.auth.password;
                this.hash = proto.auth.hash;
                this.logged_in = true;
                this.hide_popovers();
                this.show_page(pages.HOME);
                this.show_logged_in_content();
            }
            if (proto.type == Message.Type.AUTH) {
                this.hash = proto.auth.hash;
            }
            else if (proto.type == Message.Type.SET_PASSWORD) {
                this.hide_popovers();
                this.show_page(pages.PROCESSING, proto.message, proto.details, true, function (popover) {
                    this.show_page(pages.RESET);
                }.bind(this));
            }
            else if (proto.type == Message.Type.HALT) {
                $("#popover_header" + (this.popover_counter - 1)).html(proto.message);
                $("#popover_message" + (this.popover_counter - 1)).html(proto.details);
            }
            else if (proto.type == Message.Type.PROGRESS) {
                this.show_page(pages.PROCESSING, proto.message, proto.details, true);
            }
            else if (proto.type == Message.Type.SAVE_ALGORITHM) {
                this.hide_popovers();
                var success = proto.algorithm ? true : false;
                if (success) {
                    if (window.location.hash == pages.CREATE)
                        this.show_page(pages.EDIT);
                    this.set_ui_algorithm(proto.algorithm);
                    this.show_page(pages.PROCESSING, proto.message, proto.details, true);
                    this.compile_algorithm();
                }
                else
                    this.show_page(pages.SERVER_ERROR, proto.message, proto.details, true);
            }
            else if (proto.type == Message.Type.DELETE_ACCOUNT) {
                this.hide_popovers();
                this.show_page(pages.PROCESSING, proto.message, proto.details, true, function (popover) {
                    state.websocket.close();
                    state.hide_popover(popover);
                });
            }
            else if (proto.type == Message.Type.REQUEST_PASSWORD_RESET) {
                this.show_page(pages.PROCESSING, proto.message, proto.details);
            }
            else if (proto.type == Message.Type.ERROR) {
                this.show_page(pages.SERVER_ERROR, proto.message, proto.details);
            }
            else if (proto.type == Message.Type.CAPTCHA) {


                var base_64_encoded = btoa(String.fromCharCode.apply(null, proto.captcha.image));

                this.unfiltered_captcha_image = document.createElement('img');
                this.unfiltered_captcha_image.onload = (function () {
                    var canvas = document.createElement('canvas');
                    canvas.width = this.unfiltered_captcha_image.width;
                    canvas.height = this.unfiltered_captcha_image.height;

                    var ctx = canvas.getContext("2d");

                    ctx.drawImage(this.unfiltered_captcha_image, 0, 0);
                    ctx.globalCompositeOperation = 'difference';
                    ctx.fillStyle = 'white';
                    ctx.fillRect(0, 0, canvas.width, canvas.height);

                    var image_data = ctx.getImageData(0, 0, canvas.width, canvas.height);
                    var real_max = 0;
                    var real_min = 1E32;
                    for (var i = 0; i < image_data.data.length; i += 4) {
                        var max = Math.max(image_data.data[i], Math.max(image_data.data[i + 1], image_data.data[i + 2]));
                        var min = Math.min(image_data.data[i], Math.min(image_data.data[i + 1], image_data.data[i + 2]));
                        if (max < 32) {
                            image_data.data[i + 3] = 0; // alpha
                        }
                        else
                            real_min = Math.min(real_min, min);
                        real_max = Math.max(real_max, max);
                    }

                    for (var i = 0; i < image_data.data.length; i += 4) {
                        image_data.data[i] = (image_data.data[i] - real_min) / (real_max - real_min) * 256.;
                        image_data.data[i + 1] = (image_data.data[i + 1] - real_min) / (real_max - real_min) * 256.;
                        image_data.data[i + 2] = (image_data.data[i + 2] - real_min) / (real_max - real_min) * 256.;
                    }

                    ctx.putImageData(image_data, 0, 0);
                    var new_url = canvas.toDataURL();

                    $('#signup_captcha').attr('src', new_url);
                    $('#login_captcha').attr('src', new_url);
                    $('#reset_captcha').attr('src', new_url);
                    $('#request_captcha').attr('src', new_url);
                    $('#edit_captcha').attr('src', new_url);
                    $('#query_captcha').attr('src', new_url);
                    $('#delete_account_captcha').attr('src', new_url);

                    $('#signup_captcha_input').val("");
                    $('#login_captcha_input').val("");
                    $('#reset_captcha_input').val("");
                    $('#request_captcha_input').val("");
                    $('#edit_captcha_input').val("");
                    $('#query_captcha_input').val("");
                    $('#delete_account_captcha_input').val("");
                }).bind(this);
                this.unfiltered_captcha_image.src = `data:image/png;base64,${base_64_encoded}`

                this.last_captcha = proto.captcha;
            }
        }

        GlobalState.prototype.show_logged_out_content = function (new_page) {
            $.each($(".logged_in_content"), function () {
                // if ($(this).is(":visible") && ($(new_page).has($(this)).length > 0 || $(this).parents().has("#menu").length > 0))
                $(this).css("display", "none");
            });
            $.each($(".logged_out_content"), function () {
                if ($(this).is(":hidden") && ($(new_page).has($(this)).length > 0 || ($(this).parents().has("#menu").length > 0))) {
                    if ($($(this).parents()[0]).hasClass("topnav"))
                        $(this).attr("style", "");
                    else
                        $(this).fadeIn(1000).css("display", $(this).hasClass("btn") ? "inline-block" : "block");
                }
            });
        }

        GlobalState.prototype.show_logged_in_content = function (new_page) {
            $.each($(".logged_in_content"), function () {
                //if($(this).is(":hidden") && 
                if (($(new_page).has($(this)).length > 0 || ($(this).parents().has("#menu").length > 0))) {
                    if ($($(this).parents()[0]).hasClass("topnav"))
                        $(this).attr("style", "");
                    else
                        $(this).fadeIn(1000).css("display", $(this).hasClass("btn") ? "inline-block" : "block");
                }
            });
            $.each($(".logged_out_content"), function () {
                //if($(this).is(":visible") && 
                // if (($(new_page).has($(this)).length > 0 || $(this).parents().has("#menu").length > 0))
                $(this).css("display", "none");
            });
        }


        GlobalState.prototype.refresh_content = function (page) {

            $("#menu").fadeIn(1000.);
            $(".topnav-background").fadeIn(1000.)
            $("#belownav").fadeIn(1000);

            switch (page) {
                case pages.RECONNECT:
                    break;
                case pages.PROCESSING:
                    break;
                case pages.CLIENT_ERROR:
                    break;
                case pages.SERVER_ERROR:
                    break;
                case pages.RESET:
                    this.refresh_captchas();

                    $("#home_button").removeClass("active")
                    $("#browse_button").removeClass("active")
                    $("#edit_button").removeClass("active")
                    $("#create_button").removeClass("active")
                    $("#profile_button").removeClass("active")
                    $("#login_button").removeClass("active")
                    $("#signup_button").removeClass("active")
                    $("#logout_button").removeClass("active")
                    break;
                case pages.POLICY:

                    $("#home_button").removeClass("active")
                    $("#browse_button").removeClass("active")
                    $("#edit_button").removeClass("active")
                    $("#create_button").removeClass("active")
                    $("#profile_button").removeClass("active")
                    $("#login_button").removeClass("active")
                    $("#signup_button").removeClass("active")
                    $("#logout_button").removeClass("active")
                    break;
                case pages.REQUEST:
                    this.refresh_captchas();

                    $("#home_button").removeClass("active")
                    $("#browse_button").removeClass("active")
                    $("#edit_button").removeClass("active")
                    $("#create_button").removeClass("active")
                    $("#profile_button").removeClass("active")
                    $("#login_button").removeClass("active")
                    $("#signup_button").removeClass("active")
                    $("#logout_button").removeClass("active")
                    break;
                case pages.HOME:

                    $("#home_button").addClass("active")
                    $("#browse_button").removeClass("active")
                    $("#edit_button").removeClass("active")
                    $("#create_button").removeClass("active")
                    $("#profile_button").removeClass("active")
                    $("#login_button").removeClass("active")
                    $("#signup_button").removeClass("active")
                    $("#logout_button").removeClass("active")
                    break;
                case pages.BROWSE:

                    $("#home_button").removeClass("active")
                    $("#browse_button").addClass("active")
                    $("#edit_button").removeClass("active")
                    $("#create_button").removeClass("active")
                    $("#profile_button").removeClass("active")
                    $("#login_button").removeClass("active")
                    $("#signup_button").removeClass("active")
                    $("#logout_button").removeClass("active")
                    break;
                case pages.EDIT:
                    this.refresh_captchas();

                    $("#home_button").removeClass("active")
                    $("#browse_button").removeClass("active")
                    $("#edit_button").addClass("active")
                    $("#create_button").removeClass("active")
                    $("#profile_button").removeClass("active")
                    $("#login_button").removeClass("active")
                    $("#signup_button").removeClass("active")
                    $("#logout_button").removeClass("active")

                    var algorithm_query_parameter = getQueryVariable("algorithm");
                    var algorithm = algorithm_query_parameter ? algorithm_query_parameter : "background";
                    this.show_page(pages.PROCESSING, "Fetching algorithm...", "Please be patient.", false);
                    $('.loading-indicator').show()
                    this.preview_algorithm(algorithm);
                    break;
                case pages.CREATE:
                    this.refresh_captchas();

                    $("#home_button").removeClass("active")
                    $("#browse_button").removeClass("active")
                    $("#edit_button").removeClass("active")
                    $("#create_button").addClass("active")
                    $("#profile_button").removeClass("active")
                    $("#login_button").removeClass("active")
                    $("#signup_button").removeClass("active")
                    $("#logout_button").removeClass("active")

                    var algorithm_query_parameter = getQueryVariable("fork");
                    var algorithm = algorithm_query_parameter ? algorithm_query_parameter : "default";
                    this.show_page(pages.PROCESSING, "Fetching algorithm...", "Please be patient.", false);
                    $('.loading-indicator').show()
                    this.preview_algorithm(algorithm);
                    break;
                    break;
                case pages.DELETE_ACCOUNT:
                    this.refresh_captchas();
                    break;
                case pages.PROFILE:

                    $("#home_button").removeClass("active")
                    $("#browse_button").removeClass("active")
                    $("#edit_button").removeClass("active")
                    $("#create_button").removeClass("active")
                    $("#profile_button").addClass("active")
                    $("#login_button").removeClass("active")
                    $("#signup_button").removeClass("active")
                    $("#logout_button").removeClass("active")

                    var http = new XMLHttpRequest();
                    var url = 'browse_view.html';
                    var params = 'profile=' + this.user_name;
                    http.open('GET', url, true);

                    this.show_page(pages.PROCESSING, "Fetching profile...", "Please be patient.", false);
                    //Send the proper header information along with the request
                    http.setRequestHeader('Content-type', 'application/x-www-form-urlencoded');
                    http.onreadystatechange = function () {//Call a function when the state changes.
                        if (http.readyState == 4 && http.status == 200) {
                            this.hide_popovers();
                            document.getElementById("profile_algorithm_list").innerHTML = http.responseText;
                        }
                    }.bind(this);
                    http.onerror = function () {
                        this.hide_popovers();
                        this.show_page(pages.CLIENT_ERROR, "Failed to fetch profile algorithms!", "Please try a another way!", true)
                    }.bind(this);
                    http.send(params);
                    break;
                case pages.LOGIN:
                    this.refresh_captchas();

                    $("#home_button").removeClass("active")
                    $("#browse_button").removeClass("active")
                    $("#edit_button").removeClass("active")
                    $("#create_button").removeClass("active")
                    $("#profile_button").removeClass("active")
                    $("#login_button").addClass("active")
                    $("#signup_button").removeClass("active")
                    $("#logout_button").removeClass("active")
                    break;
                case pages.SIGNUP:
                    this.refresh_captchas();

                    $("#home_button").removeClass("active")
                    $("#browse_button").removeClass("active")
                    $("#edit_button").removeClass("active")
                    $("#create_button").removeClass("active")
                    $("#profile_button").removeClass("active")
                    $("#login_button").removeClass("active")
                    $("#signup_button").addClass("active")
                    $("#logout_button").removeClass("active")
                    break;
                case pages.LOGOUT:
                    this.refresh_captchas();

                    $("#home_button").removeClass("active")
                    $("#browse_button").removeClass("active")
                    $("#edit_button").removeClass("active")
                    $("#create_button").removeClass("active")
                    $("#profile_button").removeClass("active")
                    $("#login_button").removeClass("active")
                    $("#signup_button").removeClass("active")
                    $("#logout_button").addClass("active")
                    break;
            }
            $(page).animate({ scrollTop: 0 }, 250);
            $(page + " .left").animate({ scrollTop: 0 }, 250);
            $(page + " .right").animate({ scrollTop: 0 }, 250);
        }

        GlobalState.prototype.change_title = function (page) {
            var message = "";
            switch (page) {
                case pages.RECONNECT:
                    message = "Reconnect";
                    break;
                case pages.PROCESSING:
                    message = "Processing";
                    break;
                case pages.RESET:
                    message = "Password Reset";
                    break;
                case pages.POLICY:
                    message = "Site Policies";
                    break;
                case pages.REQUEST:
                    message = "Request Password Reset";
                    break;
                case pages.CLIENT_ERROR:
                    message = "Client Error";
                    break;
                case pages.SERVER_ERROR:
                    message = "Server Error";
                    break;
                case pages.HOME:
                    message = "General Information";
                    break;
                case pages.BROWSE:
                    message = "Browse Algorithms";
                    break;
                case pages.EDIT:
                    message = "Edit Algorithm";
                    break;
                case pages.CREATE:
                    message = "Create Algorithm";
                    break;
                case pages.CREATE_QUERY:
                    message = "Create Visual Query";
                    break;
                case pages.DELETE_ACCOUNT:
                    message = "Delete Account";
                    break;
                case pages.PROFILE:
                    message = "Profile";
                    break;
                case pages.LOGIN:
                    message = "Log In";
                    break;
                case pages.SIGNUP:
                    message = "Sign Up";
                    break;
            }
            document.title = message;
        }

        GlobalState.prototype.coming_soon = function () {
            this.show_page(pages.PROCESSING, "This feature is coming soon!", "Please check again at a later date.", true);
        }

        GlobalState.prototype.get_ui_stages = function () {
            var ui_stages = [];
            for (var i = 0; i < this.pipeline.stages.length; i++) {
                var stage = this.pipeline.stages[i];
                var stage_identifier = stage.identifier;
                console.log(stage_identifier);
                var ui_stage = OpenGLStage.fromObject(JSON.parse(JSON.stringify(stage)));

                ui_stage.name = $("#" + stage_identifier + '_name').val();

                ui_stage.indices = this.stage_codemirrors[i][0].getValue()
                ui_stage.vertices = this.stage_codemirrors[i][1].getValue()

                if ($("#" + stage_identifier + '_stage_shader').prop("checked"))
                    ui_stage.type = OpenGLStage.Type.SHADER;
                if ($("#" + stage_identifier + '_stage_mesh_points').prop("checked"))
                    ui_stage.type = OpenGLStage.Type.MESH_POINTS;
                if ($("#" + stage_identifier + '_stage_mesh_lines').prop("checked"))
                    ui_stage.type = OpenGLStage.Type.MESH_LINES;
                if ($("#" + stage_identifier + '_stage_mesh_line_strip').prop("checked"))
                    ui_stage.type = OpenGLStage.Type.MESH_LINE_STRIP;
                if ($("#" + stage_identifier + '_stage_mesh_line_loop').prop("checked"))
                    ui_stage.type = OpenGLStage.Type.MESH_LINE_LOOP;
                if ($("#" + stage_identifier + '_stage_mesh_triangles').prop("checked"))
                    ui_stage.type = OpenGLStage.Type.MESH_TRIANGLES;
                if ($("#" + stage_identifier + '_stage_mesh_triangle_fan').prop("checked"))
                    ui_stage.type = OpenGLStage.Type.MESH_TRIANGLE_FAN;
                if ($("#" + stage_identifier + '_stage_mesh_triangle_strip').prop("checked"))
                    ui_stage.type = OpenGLStage.Type.MESH_TRIANGLE_STRIP;

                ui_stage.context = $("#" + stage_identifier + '_context_name').val();
                ui_stage.program = $("#" + stage_identifier + '_program_name').val();

                ui_stages.push(ui_stage);
            }
            return ui_stages;
        }

        GlobalState.prototype.toggle_nav = function () {
            var x = document.getElementById("menu");
            if (x.className === "topnav") {
                x.className += " responsive";
            } else {
                x.className = "topnav";
            }
        }
        GlobalState.prototype.collapse_nav = function () {
            var x = document.getElementById("menu");
            x.className = "topnav";
        }

        function is_popover(page) {
            return page == pages.SERVER_ERROR ||
                page == pages.CLIENT_ERROR ||
                page == pages.PROCESSING;
        }

        GlobalState.prototype.show_page = function (page = pages.HOME, message = "", subtext = "", opt_out = true, completion_callback = function (popover) { if (state.popovers.length == 0 || !is_popover(this.current_page)) { $("#belownav").fadeIn(1000.); $("#menu").fadeIn(1000.); $("#menu-background").fadeIn(1000.) } }) {
            this.collapse_nav();
            console.log("SHOWING PAGE: " + page);
            this.current_page = page;

            if (page == pages.PROCESSING) {
                this.hide_popovers();
                $(function () {
                    page = 'popover' + this.popover_counter;
                    html =
                        '<div class="message_popover"\n' +
                        '    id="' + page + '">\n' +
                        '<div class="row disconnected_content"\n' +
                        '    style="margin: 0px !important; z-index: 400; position:relative; text-align:center; border:none !important; height:100%; width:100%;  overflow-y: auto; background-color: rgba(0., 0., 0., 0.);">\n' +
                        '    <div class="col-0 col-sm-0 col-md-1 col-lg-2">\n' +
                        '    </div>\n' +
                        '    <div class="col-12 col-sm-12 col-md-10 col-lg-8">\n' +
                        '        <div style="height: 20%;"></div>\n' +
                        '        <h1 style=" padding:5%; text-align:center; color:#f00; font-size: 24px !important; width:auto; background-color: rgba(0,0,0,.75); border-radius: 12px; border: 1px solid #fff !important;"\n' +
                        '            class="blink-white">\n' +
                        '            <div id="popover_header' + this.popover_counter + '" style="text-align:center; color:#0f0; font-size: 24px !important;"\n' +
                        '                class="blink-white">\n' +
                        '                ' + message + '\n' +
                        '            </div>\n' +
                        '            <br>\n' +
                        '            <label id="popover_message' + this.popover_counter + '" style="font-size: 14px !important;color: #fff;">\n' +
                        '                ' + subtext + '\n' +
                        '            </label>\n' +
                        '            <br>\n' +
                        (opt_out ? ' <br>\n' +
                            '            <div style="text-align: center;">\n' +
                            '                <button id="popover_button' + this.popover_counter + '" type="button" class="opt_out btn btn-outline-success mx-auto"\n' +
                            '                    onclick="state.popover_callback(' + this.popover_counter + ')">OK</button>\n' +
                            '            </div>\n' : "") +
                        '        </h1>\n' +
                        '    </div>\n' +
                        '    <div class="col-0 col-sm-0 col-md-1 col-lg-2">\n' +
                        '    </div>\n' +
                        '</div>\n';
                    '</div>\n';

                    var element = $(html);
                    $("#popovers").append(element);
                    element.fadeIn(1000, function (response) {
                    }.bind(this))
                    $("#popover_button" + this.popover_counter).focus();

                    this.popover_counter++;
                    this.popovers.push({
                        page: page,
                        message: message,
                        subtext: subtext,
                        opt_out: opt_out,
                        completion_callback: completion_callback
                    });
                }.bind(this));
            }
            else if (page == pages.CLIENT_ERROR) {
                this.hide_popovers();
                $(function () {
                    page = 'popover' + this.popover_counter;
                    html =
                        '<div class="message_popover"\n' +
                        '    id="' + page + '">\n' +
                        '<div class="row disconnected_content"\n' +
                        '    style="margin: 0px !important; z-index: 400; position:relative; text-align:center; border:none !important; height:100%; width:100%;  overflow-y: auto; background-color: rgba(0., 0., 0., 0.);">\n' +
                        '    <div class="col-0 col-sm-0 col-md-1 col-lg-2">\n' +
                        '    </div>\n' +
                        '    <div class="col-12 col-sm-12 col-md-10 col-lg-8">\n' +
                        '        <div style="height: 20%;"></div>\n' +
                        '        <h1 style=" padding:5%; text-align:center; color:#f00; font-size: 24px !important; width:auto; background-color: rgba(0,0,0,.75); border-radius: 12px; border: 1px solid #fff !important;"\n' +
                        '            id="error_bubble" class="blink-white">\n' +
                        '            <div id="popover_header' + this.popover_counter + '" style="text-align:center; color:#f00; font-size: 24px !important;"\n' +
                        '                class="blink-white">\n' +
                        '                ' + message + '\n' +
                        '            </div>\n' +
                        '            <br>\n' +
                        '            <label id="popover_message' + this.popover_counter + '" style="font-size: 14px !important;color: #fff;">' + subtext + '</label>\n' +
                        '            <br>\n' +
                        (opt_out ? ' <br>\n' +
                            '            <div style="text-align: center;">\n' +
                            '                <button id="popover_button' + this.popover_counter + '" type="button" class="btn btn-outline-danger mx-auto"\n' +
                            '                    onclick="state.popover_callback(' + this.popover_counter + ')">OK</button>\n' +
                            '            </div>\n' : "") +
                        '        </h1>\n' +
                        '    </div>\n' +
                        '    <div class="col-0 col-sm-0 col-md-1 col-lg-2">\n' +
                        '    </div>\n' +
                        '</div>\n';
                    '</div>\n';

                    var element = $(html);
                    $("#popovers").append(element);
                    element.fadeIn(1000, function (response) {
                    }.bind(this))
                    $("#popover_button" + this.popover_counter).focus();

                    this.popover_counter++;
                    this.popovers.push({
                        page: page,
                        message: message,
                        subtext: subtext,
                        opt_out: opt_out,
                        completion_callback: completion_callback
                    });
                }.bind(this));
            }
            else if (page == pages.SERVER_ERROR) {
                this.hide_popovers();
                $(function () {
                    page = 'popover' + this.popover_counter;
                    html =
                        '<div class="message_popover"\n' +
                        '    id="' + page + '">\n' +
                        '<div class="row disconnected_content"\n' +
                        '    style="margin: 0px !important; z-index: 400; position:relative; text-align:center; border:none !important; height:100%; width:100%;  overflow-y: auto; background-color: rgba(0., 0., 0., 0.);">\n' +
                        '    <div class="col-0 col-sm-0 col-md-1 col-lg-2">\n' +
                        '    </div>\n' +
                        '    <div class="col-12 col-sm-12 col-md-10 col-lg-8">\n' +
                        '        <div style="height: 20%;"></div>\n' +
                        '        <h1 style=" padding:5%; text-align:center; color:#f00; font-size: 24px !important; width:auto; background-color: rgba(0,0,0,.75); border-radius: 12px; border: 1px solid #fff !important;"\n' +
                        '            id="error_bubble" class="blink-white">\n' +
                        '            <div id="popover_header' + this.popover_counter + '" style="text-align:center; color:#f00; font-size: 24px !important;"\n' +
                        '                class="blink-white">\n' + message +
                        '            </div>\n' +
                        '            <br>\n' +
                        '            <label id="popover_message" style="font-size: 14px !important;color: #fff;">' + subtext + '</label>\n' +
                        '            <br>\n' +
                        (opt_out ? ' <br>\n' +
                            '            <div style="text-align: center;">\n' +
                            '                <button id="popover_button' + this.popover_counter + '" type="button" class="btn btn-outline-danger mx-auto"\n' +
                            '                    onclick="state.popover_callback(' + this.popover_counter + ')">OK</button>\n' +
                            '            </div>\n' : "") +
                        '        </h1>\n' +
                        '    </div>\n' +
                        '    <div class="col-0 col-sm-0 col-md-1 col-lg-2">\n' +
                        '    </div>\n' +
                        '</div>\n';
                    '</div>\n';

                    var element = $(html);
                    $("#popovers").append(element);
                    element.fadeIn(1000, function (response) {
                    }.bind(this))
                    $("#popover_button" + this.popover_counter).focus();

                    this.popover_counter++;
                    this.popovers.push({
                        page: page,
                        message: message,
                        subtext: subtext,
                        opt_out: opt_out,
                        completion_callback: completion_callback
                    });
                }.bind(this));
            }
            else {
                window.location.hash = page;
                this.refresh_content(page);
            }
        }
        var on_resources_loaded = function () {
            console.log($)//Show me the money
            if (typeof $ == 'undefined' ||
                typeof $('[data-toggle="tooltip"]') == 'undefined' ||
                typeof $('[data-toggle="tooltip"]').tooltip == 'undefined' ||
                !protobuf)
                window.setTimeout(on_resources_loaded, 1000);
            else {

                window.background_iframe = document.getElementById("background_iframe")
                $("#belownav").on('mousemove mousedown mouseup mousewheel', function (e) {
                    $(window.background_iframe).trigger(e);
                });
                /*Does not work!
                var copy_and_dispatch = function (event) {
                    // var eventCopy = document.createEvent("MouseEvents");
                    // eventCopy.initMouseEvent(event.type, event.bubbles, event.cancelable, event.view, event.detail,
                    //     event.pageX || event.layerX, event.pageY || event.layerY, event.clientX, event.clientY, event.ctrlKey, event.altKey,
                    //     event.shiftKey, event.metaKey, event.button, event.relatedTarget);
                    window.background_iframe.dispatchEvent(event);
                }
                document.getElementById("belownav").addEventListener('mousemove', function (e) {
                    copy_and_dispatch(e)
                });
                document.getElementById("belownav").addEventListener('mousedown', function (e) {
                    copy_and_dispatch(e)
                });
                document.getElementById("belownav").addEventListener('mouseup', function (e) {
                    copy_and_dispatch(e)
                });
                document.getElementById("belownav").addEventListener('mousewheel', function (e) {
                    copy_and_dispatch(e)
                });
                */

                $('[data-toggle="tooltip"]').tooltip();
                var pages_list = Object.values(pages);
                var most_likely_page = "home";
                for (var i = 0; i < pages_list.length; i++) {
                    if (!is_popover(pages_list[i])) {
                        var page_name = pages_list[i].substring(1);
                        if (("#" + page_name) == window.location.hash) {
                            if (!is_popover(("#" + page_name))) {
                                most_likely_page = page_name;
                            }
                        }
                    }
                }
                state.wait_for_proto_and_connect(most_likely_page)
            }
            // window.addEventListener('popstate', (event) => {
            //     if (is_popover(window.location.hash) ||
            //         window.location.hash == pages.DELETE_ACCOUNT ||
            //         window.location.hash == pages.LOGOUT ||
            //         window.location.hash == pages.RESET)
            //         window.location.hash = pages.HOME;
            // });
            window.addEventListener('hashchange', function () {
                this.refresh_content(window.location.hash);
            }.bind(state));
        }

        GlobalState.prototype.popover_callback = function (identifier_index) {
            var page = "popover" + identifier_index;
            for (var i = 0; i < this.popovers.length; i++) {
                if (this.popovers[i].page == page) {
                    this.popovers[i].completion_callback(this.popovers[i]);
                    state.hide_popover(this.popovers[i])
                    i--;
                }
            }
        }

        GlobalState.prototype.hide_popovers = function () {
            for (var i = 0; i < this.popovers.length; i++) {
                if (!this.popovers[i].opt_out) {
                    element = $("#" + this.popovers[i].page);
                    element.animate({
                        top: "-100%"
                    }, 1000, function () {
                        element.remove();
                    });
                    this.popovers[i].completion_callback(this.popovers[i]);
                    this.popovers.splice(i, 1)
                    i--;
                }
            }

            this.refresh_codemirrors();
        }

        GlobalState.prototype.hide_popover = function (popover) {
            for (var i = 0; i < this.popovers.length; i++) {
                if (this.popovers[i].page == popover.page) {
                    element = $("#" + this.popovers[i].page);
                    element.animate({
                        top: "-100%"
                    }, 1000, function () {
                        element.remove();
                    });
                    this.popovers.splice(i, 1)
                    i--;
                }
            }
        }

        GlobalState.prototype.register = function () {
            var name = $("#signup_name").val();
            var valid_name = name.length >= 3;

            if (!valid_name) {
                this.show_page(pages.CLIENT_ERROR, "Error!", "Please enter a valid user name (use 3 or more characters).", true);
                return;
            }

            var email = $("#signup_email").val();
            var valid_email = /^\w+([\.-]?\w+)*@\w+([\.-]?\w+)*(\.\w{2,3})+$/.test(email);

            if (!valid_email) {
                this.show_page(pages.CLIENT_ERROR, "Error!", "Please enter a valid email.", true);
                return;
            }

            var captcha = $("#signup_captcha_input").val();
            this.show_page(pages.PROCESSING, "Registering...", "Please be patient.", false);

            this.send(Message.encode({
                type: Message.Type.REGISTER,
                auth: {
                    user: name,
                    email: email,
                    password: ""
                },
                captcha: {
                    key: captcha
                }
            }).finish())
        }

        //Utility function
        function getQueryVariable(variable, default_value) {
            var query = window.location.search.substring(1);
            var vars = query.split('&');
            for (var i = 0; i < vars.length; i++) {
                var pair = vars[i].split('=');
                if (decodeURIComponent(pair[0]) == variable) {
                    return decodeURIComponent(pair[1]);
                }
            }
            return default_value;
        }

        //Utility function
        function setQueryVariable(variable, value) {
            var query = window.location.search.substring(1);
            var vars = query.split('&');
            var pairs = [];
            var found = false;
            for (var i = 0; i < vars.length; i++) {
                var pair = vars[i].split('=');
                if (decodeURIComponent(pair[0]) == variable) {
                    if (pair.length > 1)
                        pair[1] = encodeURIComponent(value);
                    else
                        pair.push(encodeURIComponent(value))
                    found = true;
                }
                pairs.push(pair);
            }

            if (!found)
                pairs.push([variable, encodeURIComponent(value)]);

            var new_search = "?"

            for (var i = 0; i < pairs.length; i++) {
                if (pairs[i].length > 1) {
                    new_search += pairs[i][0] + "=" + pairs[i][1];
                    if (i != pairs.length - 1)
                        new_search += "&";
                }
            }

            var new_url = window.location.protocol + "//" + window.location.host + window.location.pathname + new_search + window.location.hash;;
            window.history.replaceState({}, document.title, new_url);
        }


        GlobalState.prototype.set_password = function () {
            var pwd = $("#reset_password").val()
            if (pwd != $("#reset_retype").val()) {
                this.show_page(pages.CLIENT_ERROR, "Error!", "Please enter passwords that match. Use at least one number, at least one letter, and at least six characters.", true);
                return;
            }
            var valid_pwd = /(?=.*\d)(?=.*[a-zA-Z]).{6,}/.test(pwd);
            if (!valid_pwd) {
                this.show_page(pages.CLIENT_ERROR, "Error!", "Please enter a valid password. Use at least one number, at least one letter, and at least six characters.", true);
                return;
            }

            var captcha = $("#reset_captcha_input").val();


            this.show_page(pages.PROCESSING, "Setting password...", "Please wait...", false);
            this.send(Message.encode({
                type: Message.Type.SET_PASSWORD,
                auth: {
                    user: this.user_name,
                    password: pwd,
                    hash: this.hash
                },
                captcha: {
                    key: captcha
                }
            }).finish())
        }

        function removeURLParameter(url, parameter) {
            var urlparts = url.split('?');
            if (urlparts.length >= 2) {

                var prefix = encodeURIComponent(parameter) + '=';
                var pars = urlparts[1].split(/[&;]/g);

                for (var i = pars.length; i-- > 0;) {
                    if (pars[i].lastIndexOf(prefix, 0) !== -1) {
                        pars.splice(i, 1);
                    }
                }

                return urlparts[0] + (pars.length > 0 ? '?' + pars.join('&') : '');
            }
            return url;
        }

        GlobalState.prototype.send_request = function () {
            var name_or_email = $("#request_password_reset").val();
            var valid_name = name_or_email.length >= 3;
            var valid_email = /^\w+([\.-]?\w+)*@\w+([\.-]?\w+)*(\.\w{2,3})+$/.test(name_or_email);

            if (!valid_name && !valid_email) {
                this.show_page(pages.CLIENT_ERROR, "Error!", "Please enter a valid name or email.", true);
                return;
            }

            var captcha = $("#request_captcha_input").val();


            this.show_page(pages.PROCESSING, "Sending request...", "Please wait...", false);
            this.send(Message.encode({
                type: Message.Type.REQUEST_PASSWORD_RESET,
                auth: {
                    user: name_or_email,
                    email: name_or_email,
                    password: ""
                },
                captcha: {
                    key: captcha
                }
            }).finish())
        }
        GlobalState.prototype.logout = function () {
            if (this.websocket.readyState == WebSocket.OPEN) {
                this.websocket.close();
            }
        }
        GlobalState.prototype.start_algorithm_delete = function (index) {
            window.delete_algorithm_index = index;
            this.show_page(pages.DELETE_ALGORITHM);
        }
        GlobalState.prototype.end_algorithm_delete = function () {
            this.show_page(pages.PROCESSING, "Deleting algorithm...", "Please be patient.", true);

            var json = {
                type: Message.Type.DELETE_ALGORITHM,
                auth: {
                    user: this.user_name,
                    hash: this.hash
                },
                video: {
                    serverName: this.profile_results.catalog.videos[window.delete_algorithm_index].serverName
                }
            }

            var encoded = Message.encode(json).finish();

            this.deleting_algorithm = true;
            this.send(encoded);
        }
        GlobalState.prototype.delete_account = function () {
            var value_entered = $("#login_name_or_email_delete").val()
            var captcha = $("#delete_account_captcha").val();
            if (this.user_name.toLowerCase() == (value_entered).toLowerCase() || this.user_email.toLowerCase() == (value_entered).toLowerCase()) {
                this.show_page(pages.PROCESSING, "Deleting account...", "Please wait...", false);
                this.send(Message.encode({
                    type: Message.Type.DELETE_ACCOUNT,
                    auth: {
                        user: this.user_name,
                        email: this.user_email,
                        hash: this.hash
                    },
                    captcha: {
                        key: captcha
                    }
                }).finish())
            }
            else {
                this.show_page(pages.CLIENT_ERROR, "Invalid account...", "Please make sure you have a valid login session.", true);
            }
            this.deleting_account = true;
        }


        GlobalState.prototype.login = function () {
            var email_or_name = $("#login_name_or_email").val();
            var pwd = $("#login_password").val();
            var captcha = $("#login_captcha_input").val();


            this.show_page(pages.PROCESSING, "Logging in...", "Please wait...", false);
            this.send(Message.encode({
                type: Message.Type.LOGIN,
                auth: {
                    user: email_or_name,
                    email: email_or_name,
                    password: pwd
                },
                captcha: {
                    key: captcha
                }
            }).finish())
        }


        GlobalState.prototype.toggle_html = function () {
            var c = $(window.location.hash + "_algorithm_html_checkbox")
            var html = c.prop("checked");

            if (html)
                $(window.location.hash + "_algorithm_html").show();
            else
                $(window.location.hash + "_algorithm_html").hide();
        }
        GlobalState.prototype.toggle_javascript = function () {
            var c = $(window.location.hash + "_algorithm_javascript_checkbox")
            var has_javascript = c.prop("checked");

            if (has_javascript)
                $(window.location.hash + "_algorithm_javascript").show();
            else
                $(window.location.hash + "_algorithm_javascript").hide();
        }
        GlobalState.prototype.compile_algorithm = function () {
            this.preview_iframe = document.getElementById(window.location.hash.substring(1) + "_preview_iframe");
            if (this.preview_iframe)
                this.preview_iframe.contentWindow.postMessage(JSON.stringify({ proto: this.get_ui_algorithm() }), '*');
            else
                console.log("Error! No iframe loaded.");
        }

        GlobalState.prototype.preview_algorithm = function (algorithm) {
            this.preview_iframe = document.getElementById(window.location.hash.substring(1) + "_preview_iframe");
            this.preview_iframe.onload = function () {
                this.preview_iframe.contentWindow.postMessage(JSON.stringify({ fetch_algorithm: true }), '*');
            }.bind(this);
            this.preview_iframe.src = "canvas.html?algorithm=" + algorithm;
        }

        window.edit_html_editor = CodeMirror.fromTextArea(document.getElementById("edit_algorithm_html_textarea"), { autoRefresh: true, lineWrapping: true, lineNumbers: true, viewPortMargin: Infinity, theme: 'the-matrix height-auto', mode: 'xml' });
        window.edit_javascript_editor = CodeMirror.fromTextArea(document.getElementById("edit_algorithm_javascript_textarea"), { autoRefresh: true, lineWrapping: true, lineNumbers: true, viewPortMargin: Infinity, theme: 'the-matrix height-auto', mode: 'javascript' })
        window.edit_html_editor.setValue('<!--Enter HTML here. -->');
        window.edit_javascript_editor.setValue('//Enter JavaScript here.');

        window.create_html_editor = CodeMirror.fromTextArea(document.getElementById("create_algorithm_html_textarea"), { autoRefresh: true, lineWrapping: true, lineNumbers: true, viewPortMargin: Infinity, theme: 'the-matrix height-auto', mode: 'xml' });
        window.create_javascript_editor = CodeMirror.fromTextArea(document.getElementById("create_algorithm_javascript_textarea"), { autoRefresh: true, lineWrapping: true, lineNumbers: true, viewPortMargin: Infinity, theme: 'the-matrix height-auto', mode: 'javascript' });
        window.create_html_editor.setValue('<!--Enter HTML here. -->');
        window.create_javascript_editor.setValue('//Enter JavaScript here.');

        GlobalState.prototype.mutex_checkboxes = function (checkboxes, global_change) {
            for (var i = 0; i < checkboxes.length; i++) {
                document.getElementById(checkboxes[i]).onclick = (function (checkboxes, i, global_change) {
                    return function (event) {
                        var mutex_these = [];
                        var skipped_checkbox = null;
                        for (var j = 0; j < checkboxes.length; j++) {
                            if (j == i) {
                                skipped_checkbox = checkboxes[j];
                                continue;
                            }
                            mutex_these.push(checkboxes[j]);
                        }

                        var total_mutex = true;
                        for (var j = 0; j < mutex_these.length; j++)
                            total_mutex = (!$("#" + mutex_these[j]).prop("checked")) && total_mutex;

                        if (total_mutex) {
                            $("#" + skipped_checkbox).prop("checked", true);
                        }
                        else {
                            for (var j = 0; j < checkboxes.length; j++) {
                                if (j == i)
                                    continue;
                                $("#" + checkboxes[j]).prop("checked", false);
                            }
                        }
                        if (global_change)
                            global_change();
                    }
                })(checkboxes, i, global_change)
            }
        }

        GlobalState.prototype.render_contexts = function (contexts) {
            var html = "";
            for (var i = 0; i < contexts.length; i++) {
                var context = contexts[i];

                if (!window.context_counter)
                    window.context_counter = 0;
                var new_context_index = window.context_counter++;

                var name_prefix = window.location.hash.substring(1) + "_context_identifier_";
                var context_identifier = name_prefix + new_context_index;
                this.pipeline.contexts[i].identifier = context_identifier;
                context.identifier = context_identifier;

                html +=
                    '<h1 class="editable" id="' + context_identifier + '" \n' +
                    'style="padding-top: 14px; padding-bottom: 14px;text-align:center; color:#fff; font-size: 14px !important; width:auto; background-color: rgba(0,0,0,.75); border-radius: 12px; border: 1px solid #fff !important;">\n' +
                    '   <div class="row">\n' +
                    '        <div class="col-12 col-sm-12 col-md-6 col-lg-6" style="align-self: center;">\n' +
                    '            <a>Context Identifier:</a>\n' +
                    '            <br>\n' +
                    '            <br>\n' +
                    '        </div>\n' +
                    '        <div class="col-12 col-sm-12 col-md-6 col-lg-6">\n' +
                    '            <input id="' + context_identifier + '_name" style="width:inherit; text-align:center; color:#fff;" placeholder="Context name..."\n' +
                    '                value="' + context.name + '"></input>\n' +
                    '            <br>\n' +
                    '            <br>\n' +
                    '\n' +
                    '        </div>\n' +
                    '    </div>\n' +
                    '    <div class="row">\n' +
                    '        <div class="col-6 col-sm-6 col-md-6 col-lg-6" style="align-self: flex-end; text-align: right">\n' +
                    '            <a>Depth Component:</a>\n' +
                    '        </div>\n' +
                    '        <div class="col-2 col-sm-2 col-md-2 col-lg-2" style="text-align: left;">\n' +
                    '            <div class="checkbox">\n' +
                    '                <input style="float:right;" id="' + context_identifier + '_depth_checkbox" type="checkbox" ' + (context.depth_test ? "checked" : "") + '>\n' +
                    '                <label for="' + context_identifier + '_depth_checkbox"></label>\n' +
                    '            </div>\n' +
                    '        </div>\n' +
                    '        <div class="col-2 col-sm-2 col-md-2 col-lg-2" style="text-align: center;">\n' +
                    '        </div>\n' +
                    '        <div class="col-2 col-sm-2 col-md-2 col-lg-2" style="text-align: center;">\n' +
                    '        </div>\n' +
                    '    </div>\n' +
                    '    <br>\n' +
                    '    <div class="row" style="border-top: 1px solid #fff;">\n' +
                    '        <div class="col-12 col-sm-12 col-md-12 col-lg-12">\n' +
                    '            <br>\n' +
                    '            <a>Context Width:</a>\n' +
                    '            <br>\n' +
                    '            <br>\n' +
                    '        </div>\n' +
                    '    </div>\n' +
                    '    <div class="row">\n' +
                    '        <div class="col-6 col-sm-6 col-md-6 col-lg-6" style="align-self: flex-end; text-align: right">\n' +
                    '            <a>SCREEN SIZE</a>\n' +
                    '        </div>\n' +
                    '        <div class="col-2 col-sm-2 col-md-2 col-lg-2" style="text-align: left;">\n' +
                    '            <div class="checkbox">\n' +
                    '                <input style="float:right;" id="' + context_identifier + '_width_screen_size" type="checkbox">\n' +
                    '                <label for="' + context_identifier + '_width_screen_size"></label>\n' +
                    '            </div>\n' +
                    '        </div>\n' +
                    '        <div class="col-2 col-sm-2 col-md-2 col-lg-2" style="text-align: center;">\n' +
                    '        </div>\n' +
                    '        <div class="col-2 col-sm-2 col-md-2 col-lg-2" style="text-align: center;">\n' +
                    '        </div>\n' +
                    '    </div>\n' +
                    '    <br>\n' +
                    '    <div class="row">\n' +
                    '        <div class="col-6 col-sm-6 col-md-6 col-lg-6" style="align-self: flex-end; text-align: right">\n' +
                    '            <a>NEXT LOWEST POWER OF TWO</a>\n' +
                    '        </div>\n' +
                    '        <div class="col-2 col-sm-2 col-md-2 col-lg-2" style="text-align: left;">\n' +
                    '            <div class="checkbox">\n' +
                    '                <input style="float:right;" id="' + context_identifier + '_width_next_lowest_power_of_two" type="checkbox">\n' +
                    '                <label for="' + context_identifier + '_width_next_lowest_power_of_two"></label>\n' +
                    '            </div>\n' +
                    '        </div>\n' +
                    '        <div class="col-2 col-sm-2 col-md-2 col-lg-2" style="text-align: center;">\n' +
                    '        </div>\n' +
                    '        <div class="col-2 col-sm-2 col-md-2 col-lg-2" style="text-align: center;">\n' +
                    '        </div>\n' +
                    '    </div>\n' +
                    '    <br>\n' +
                    '    <div class="row">\n' +
                    '        <div class="col-6 col-sm-6 col-md-6 col-lg-6" style="align-self: flex-end; text-align: right">\n' +
                    '            <a>NEXT HIGHEST POWER OF TWO</a>\n' +
                    '        </div>\n' +
                    '        <div class="col-2 col-sm-2 col-md-2 col-lg-2" style="text-align: left;">\n' +
                    '            <div class="checkbox">\n' +
                    '                <input style="float:right;" id="' + context_identifier + '_width_next_highest_power_of_two" type="checkbox">\n' +
                    '                <label for="' + context_identifier + '_width_next_highest_power_of_two"></label>\n' +
                    '            </div>\n' +
                    '        </div>\n' +
                    '        <div class="col-2 col-sm-2 col-md-2 col-lg-2" style="text-align: center;">\n' +
                    '        </div>\n' +
                    '        <div class="col-2 col-sm-2 col-md-2 col-lg-2" style="text-align: center;">\n' +
                    '        </div>\n' +
                    '    </div>\n' +
                    '    <br>\n' +
                    '    <div class="row">\n' +
                    '        <div class="col-6 col-sm-6 col-md-6 col-lg-6" style="align-self: flex-end; text-align: right">\n' +
                    '            <a>EXACT</a>\n' +
                    '        </div>\n' +
                    '        <div class="col-2 col-sm-2 col-md-2 col-lg-2" style="text-align: left;">\n' +
                    '            <div class="checkbox">\n' +
                    '                <input style="float:right;" id="' + context_identifier + '_width_exact" type="checkbox">\n' +
                    '                <label for="' + context_identifier + '_width_exact"></label>\n' +
                    '            </div>\n' +
                    '        </div>\n' +
                    '        <div class="col-2 col-sm-2 col-md-2 col-lg-2" style="text-align: center;">\n' +
                    '        </div>\n' +
                    '        <div class="col-2 col-sm-2 col-md-2 col-lg-2" style="text-align: center;">\n' +
                    '        </div>\n' +
                    '    </div>\n' +
                    '    <br>\n' +
                    '    <div class="row">\n' +
                    '        <div class="col-12 col-sm-12 col-md-12 col-lg-12">\n' +
                    '            <textarea id="' + context_identifier + '_width_exact_js" rows="8"\n' +
                    '                style="text-align:left; border: 1px solid #FFF;" placeholder="Enter JavaScript here..."\n' +
                    '                value="{algorithm.client}"></textarea>\n' +
                    '        </div>\n' +
                    '        <br>\n' +
                    '    </div>\n' +
                    '    <br>\n' +



                    '    <div class="row" style="border-top: 1px solid #fff;">\n' +
                    '        <div class="col-12 col-sm-12 col-md-12 col-lg-12">\n' +
                    '            <br>\n' +
                    '            <a>Context Height:</a>\n' +
                    '            <br>\n' +
                    '            <br>\n' +
                    '        </div>\n' +
                    '    </div>\n' +
                    '    <div class="row">\n' +
                    '        <div class="col-6 col-sm-6 col-md-6 col-lg-6" style="align-self: flex-end; text-align: right">\n' +
                    '            <a>SCREEN SIZE</a>\n' +
                    '        </div>\n' +
                    '        <div class="col-2 col-sm-2 col-md-2 col-lg-2" style="text-align: left;">\n' +
                    '            <div class="checkbox">\n' +
                    '                <input style="float:right;" id="' + context_identifier + '_height_screen_size" type="checkbox">\n' +
                    '                <label for="' + context_identifier + '_height_screen_size"></label>\n' +
                    '            </div>\n' +
                    '        </div>\n' +
                    '        <div class="col-2 col-sm-2 col-md-2 col-lg-2" style="text-align: center;">\n' +
                    '        </div>\n' +
                    '        <div class="col-2 col-sm-2 col-md-2 col-lg-2" style="text-align: center;">\n' +
                    '        </div>\n' +
                    '    </div>\n' +
                    '    <br>\n' +
                    '    <div class="row">\n' +
                    '        <div class="col-6 col-sm-6 col-md-6 col-lg-6" style="align-self: flex-end; text-align: right">\n' +
                    '            <a>NEXT LOWEST POWER OF TWO</a>\n' +
                    '        </div>\n' +
                    '        <div class="col-2 col-sm-2 col-md-2 col-lg-2" style="text-align: left;">\n' +
                    '            <div class="checkbox">\n' +
                    '                <input style="float:right;" id="' + context_identifier + '_height_next_lowest_power_of_two" type="checkbox">\n' +
                    '                <label for="' + context_identifier + '_height_next_lowest_power_of_two"></label>\n' +
                    '            </div>\n' +
                    '        </div>\n' +
                    '        <div class="col-2 col-sm-2 col-md-2 col-lg-2" style="text-align: center;">\n' +
                    '        </div>\n' +
                    '        <div class="col-2 col-sm-2 col-md-2 col-lg-2" style="text-align: center;">\n' +
                    '        </div>\n' +
                    '    </div>\n' +
                    '    <br>\n' +
                    '    <div class="row">\n' +
                    '        <div class="col-6 col-sm-6 col-md-6 col-lg-6" style="align-self: flex-end; text-align: right">\n' +
                    '            <a>NEXT HIGHEST POWER OF TWO</a>\n' +
                    '        </div>\n' +
                    '        <div class="col-2 col-sm-2 col-md-2 col-lg-2" style="text-align: left;">\n' +
                    '            <div class="checkbox">\n' +
                    '                <input style="float:right;" id="' + context_identifier + '_height_next_highest_power_of_two" type="checkbox">\n' +
                    '                <label for="' + context_identifier + '_height_next_highest_power_of_two"></label>\n' +
                    '            </div>\n' +
                    '        </div>\n' +
                    '        <div class="col-2 col-sm-2 col-md-2 col-lg-2" style="text-align: center;">\n' +
                    '        </div>\n' +
                    '        <div class="col-2 col-sm-2 col-md-2 col-lg-2" style="text-align: center;">\n' +
                    '        </div>\n' +
                    '    </div>\n' +
                    '    <br>\n' +
                    '    <div class="row">\n' +
                    '        <div class="col-6 col-sm-6 col-md-6 col-lg-6" style="align-self: flex-end; text-align: right">\n' +
                    '            <a>EXACT</a>\n' +
                    '        </div>\n' +
                    '        <div class="col-2 col-sm-2 col-md-2 col-lg-2" style="text-align: left;">\n' +
                    '            <div class="checkbox">\n' +
                    '                <input style="float:right;" id="' + context_identifier + '_height_exact" type="checkbox">\n' +
                    '                <label for="' + context_identifier + '_height_exact"></label>\n' +
                    '            </div>\n' +
                    '        </div>\n' +
                    '        <div class="col-2 col-sm-2 col-md-2 col-lg-2" style="text-align: center;">\n' +
                    '        </div>\n' +
                    '        <div class="col-2 col-sm-2 col-md-2 col-lg-2" style="text-align: center;">\n' +
                    '        </div>\n' +
                    '    </div>\n' +
                    '    <br>\n' +
                    '    <div class="row">\n' +
                    '        <div class="col-12 col-sm-12 col-md-12 col-lg-12">\n' +
                    '            <textarea id="' + context_identifier + '_height_exact_js" rows="8"\n' +
                    '                style="text-align:left; border: 1px solid #FFF;" placeholder="Enter JavaScript here..."\n' +
                    '                value="{algorithm.client}"></textarea>\n' +
                    '        </div>\n' +
                    '        <br>\n' +
                    '    </div>\n' +

                    '    <br>\n' +
                    '\n' +
                    '\n' +
                    '\n' +
                    '\n' +
                    '    <div class="row">\n' +
                    '        <div class="col-6 col-sm-6 col-md-6 col-lg-6">\n' +
                    '            <button type="button" ' + (i == 0 ? "disabled" : "onclick='state.move_context_up(" + i + ")'") + ' id="' + context_identifier + '_move_up" class="btn btn-outline-warning mx-auto">Move Context Up</button>\n' +
                    '            <br>\n' +
                    '        </div>\n' +
                    '        <div class="col-6 col-sm-6 col-md-6 col-lg-6">\n' +
                    '            <button type="button" ' + (i == contexts.length - 1 ? "disabled" : "onclick='state.move_context_down(" + i + ")'") + ' id="' + context_identifier + '_move_down" class="btn btn-outline-warning mx-auto">Move Context Down</button>\n' +
                    '            <br>\n' +
                    '        </div>\n' +
                    '    </div>\n' +
                    '    <br>\n' +
                    '\n' +
                    '\n' +
                    '    <div class="row">\n' +
                    '        <div class="col-6 col-sm-6 col-md-6 col-lg-6">\n' +
                    '            <button type="button" ' + ("onclick='state.duplicate_context(" + i + ")'") + ' id="' + context_identifier + '_duplicate" class="btn btn-outline-primary mx-auto">Duplicate Context</button>\n' +
                    '            <br>\n' +
                    '        </div>\n' +
                    '        <div class="col-6 col-sm-6 col-md-6 col-lg-6">\n' +
                    '            <button type="button" ' + ("onclick='state.delete_context(" + i + ")'") + ' id="' + context_identifier + '_delete" class="btn btn-outline-danger mx-auto">Delete Context</button>\n' +
                    '            <br>\n' +
                    '        </div>\n' +
                    '    </div>\n' +
                    '</h1>\n';
            }
            $(window.location.hash + "_algorithm_contexts").html(html);

            this.context_codemirrors = [];

            for (var i = 0; i < contexts.length; i++) {
                var context = contexts[i];
                var context_identifier = context.identifier;
                width_editor = CodeMirror.fromTextArea(document.getElementById(context_identifier + '_width_exact_js'), { autoRefresh: true, lineWrapping: true, lineNumbers: true, viewPortMargin: Infinity, theme: 'the-matrix height-auto', mode: 'javascript' });
                width_editor.getWrapperElement().id = context_identifier + '_width_exact_js_editor';
                width_editor.setValue(context.width.value);
                this.context_codemirrors.push(width_editor);

                height_editor = CodeMirror.fromTextArea(document.getElementById(context_identifier + '_height_exact_js'), { autoRefresh: true, lineWrapping: true, lineNumbers: true, viewPortMargin: Infinity, theme: 'the-matrix height-auto', mode: 'javascript' });
                height_editor.getWrapperElement().id = context_identifier + '_height_exact_js_editor';
                height_editor.setValue(context.height.value);
                this.context_codemirrors.push(height_editor);

                this.mutex_checkboxes([context_identifier + '_width_screen_size',
                context_identifier + '_width_next_lowest_power_of_two',
                context_identifier + '_width_next_highest_power_of_two',
                context_identifier + '_width_exact'],
                    (function (context_identifier) {
                        return function () {
                            if ($("#" + context_identifier + '_width_exact').prop("checked"))
                                $("#" + context_identifier + "_width_exact_js_editor").show();
                            else
                                $("#" + context_identifier + "_width_exact_js_editor").hide();
                        }
                    })(context_identifier));

                this.mutex_checkboxes([context_identifier + '_height_screen_size',
                context_identifier + '_height_next_lowest_power_of_two',
                context_identifier + '_height_next_highest_power_of_two',
                context_identifier + '_height_exact'],
                    (function (context_identifier) {
                        return function () {
                            if ($("#" + context_identifier + '_height_exact').prop("checked"))
                                $("#" + context_identifier + "_height_exact_js_editor").show();
                            else
                                $("#" + context_identifier + "_height_exact_js_editor").hide();
                        }
                    })(context_identifier));

                if (context.width.type == OpenGLDimension.Type.SCREEN_SIZE)
                    $("#" + context_identifier + '_width_screen_size').prop("checked", false).click();
                if (context.width.type == OpenGLDimension.Type.NEXT_LOWEST_POWER_OF_TWO)
                    $("#" + context_identifier + '_width_next_lowest_power_of_two').prop("checked", false).click();
                if (context.width.type == OpenGLDimension.Type.NEXT_HIGHEST_POWER_OF_TWO)
                    $("#" + context_identifier + '_width_next_highest_power_of_two').prop("checked", false).click();
                if (context.width.type == OpenGLDimension.Type.EXACT)
                    $("#" + context_identifier + '_width_exact').prop("checked", false).click();

                if (context.height.type == OpenGLDimension.Type.SCREEN_SIZE)
                    $("#" + context_identifier + '_height_screen_size').prop("checked", false).click();
                if (context.height.type == OpenGLDimension.Type.NEXT_LOWEST_POWER_OF_TWO)
                    $("#" + context_identifier + '_height_next_lowest_power_of_two').prop("checked", false).click();
                if (context.height.type == OpenGLDimension.Type.NEXT_HIGHEST_POWER_OF_TWO)
                    $("#" + context_identifier + '_height_next_highest_power_of_two').prop("checked", false).click();
                if (context.height.type == OpenGLDimension.Type.EXACT)
                    $("#" + context_identifier + '_height_exact').prop("checked", false).click();
            }
        }

        GlobalState.prototype.get_ui_contexts = function () {
            var ui_contexts = [];
            for (var i = 0; i < this.pipeline.contexts.length; i++) {
                var context = this.pipeline.contexts[i];
                var context_identifier = context.identifier;
                console.log(context_identifier);
                var ui_context = OpenGLContext.fromObject(JSON.parse(JSON.stringify(context)));

                ui_context.name = $("#" + context_identifier + '_name').val();

                if ($("#" + context_identifier + '_depth_checkbox').prop("checked"))
                    ui_context.depth_test = true;
                else
                    ui_context.depth_test = false;

                if ($("#" + context_identifier + '_width_screen_size').prop("checked"))
                    ui_context.width.type = OpenGLDimension.Type.SCREEN_SIZE;
                else if ($("#" + context_identifier + '_width_next_lowest_power_of_two').prop("checked"))
                    ui_context.width.type = OpenGLDimension.Type.NEXT_LOWEST_POWER_OF_TWO;
                else if ($("#" + context_identifier + '_width_next_highest_power_of_two').prop("checked"))
                    ui_context.width.type = OpenGLDimension.Type.NEXT_HIGHEST_POWER_OF_TWO;
                else if ($("#" + context_identifier + '_width_exact').prop("checked"))
                    ui_context.width.type = OpenGLDimension.Type.EXACT;

                if ($("#" + context_identifier + '_height_screen_size').prop("checked"))
                    ui_context.height.type = OpenGLDimension.Type.SCREEN_SIZE;
                else if ($("#" + context_identifier + '_height_next_lowest_power_of_two').prop("checked"))
                    ui_context.height.type = OpenGLDimension.Type.NEXT_LOWEST_POWER_OF_TWO;
                else if ($("#" + context_identifier + '_height_next_highest_power_of_two').prop("checked"))
                    ui_context.height.type = OpenGLDimension.Type.NEXT_HIGHEST_POWER_OF_TWO;
                else if ($("#" + context_identifier + '_height_exact').prop("checked"))
                    ui_context.height.type = OpenGLDimension.Type.EXACT;

                ui_context.width.value = this.context_codemirrors[i * 2 + 0].getValue()
                ui_context.height.value = this.context_codemirrors[i * 2 + 1].getValue()

                ui_contexts.push(ui_context);
            }
            return ui_contexts;
        }


        GlobalState.prototype.add_context = function (new_context = default_algorithm_context) {
            new_context = OpenGLContext.fromObject(JSON.parse(JSON.stringify(new_context)));

            var ui_contexts = this.get_ui_contexts();

            ui_contexts.push(new_context);
            this.pipeline.contexts.push(new_context);
            this.render_contexts(ui_contexts);
        }

        GlobalState.prototype.delete_context = function (index) {
            var ui_contexts = this.get_ui_contexts();

            ui_contexts.splice(index, 1);
            this.pipeline.contexts.splice(index, 1);
            this.render_contexts(ui_contexts);
        }

        GlobalState.prototype.duplicate_context = function (index) {
            var ui_contexts = this.get_ui_contexts();
            new_context = JSON.parse(JSON.stringify(ui_contexts[index]));

            ui_contexts.push(new_context);
            this.pipeline.contexts.push(new_context);
            this.render_contexts(ui_contexts);
        }
        GlobalState.prototype.move_context_up = function (index) {
            var ui_contexts = this.get_ui_contexts();

            var new_contexts = [];

            new_contexts = new_contexts.concat(ui_contexts.splice(0, index - 1));
            var moving_context = ui_contexts.splice(0, 1);
            new_contexts = new_contexts.concat(ui_contexts.splice(0, 1));
            new_contexts = new_contexts.concat(moving_context);
            new_contexts = new_contexts.concat(ui_contexts);

            this.pipeline.contexts = new_contexts;
            this.render_contexts(new_contexts);
        }
        GlobalState.prototype.move_context_down = function (index) {
            var ui_contexts = this.get_ui_contexts();

            var new_contexts = [];

            new_contexts = new_contexts.concat(ui_contexts.splice(0, index));
            var moving_context = ui_contexts.splice(0, 1);
            new_contexts = new_contexts.concat(ui_contexts.splice(0, 1));
            new_contexts = new_contexts.concat(moving_context);
            new_contexts = new_contexts.concat(ui_contexts);

            this.pipeline.contexts = new_contexts;
            this.render_contexts(new_contexts);
        }

        GlobalState.prototype.render_programs = function (programs) {
            var html = "";
            for (var i = 0; i < programs.length; i++) {
                var program = programs[i];

                if (!window.program_counter)
                    window.program_counter = 0;
                var new_program_index = window.program_counter++;

                var name_prefix = window.location.hash.substring(1) + "_program_identifier_";
                var program_identifier = name_prefix + new_program_index;
                this.pipeline.programs[i].identifier = program_identifier;
                program.identifier = program_identifier;

                html += '<h1 class="editable" id="' + program_identifier + '" \n' +
                    'style="padding-top: 14px; padding-bottom: 14px;text-align:center; color:#fff; font-size: 14px !important; width:auto; background-color: rgba(0,0,0,.75); border-radius: 12px; border: 1px solid #fff !important;">\n' +
                    '   <div class="row">\n' +
                    '        <div class="col-12 col-sm-12 col-md-6 col-lg-6" style="align-self: center;">\n' +
                    '            <a>Program Identifier:</a>\n' +
                    '            <br>\n' +
                    '            <br>\n' +
                    '        </div>\n' +
                    '        <div class="col-12 col-sm-12 col-md-6 col-lg-6">\n' +
                    '            <input id="' + program_identifier + '_name" style="width:inherit; text-align:center; color:#fff;" placeholder="Program name..."\n' +
                    '                value="' + program.name + '"></input>\n' +
                    '            <br>\n' +
                    '            <br>\n' +
                    '\n' +
                    '        </div>\n' +
                    '    </div>\n' +
                    '    <br>\n' +
                    '\n' +
                    '    <div class="row">\n' +
                    '        <div class="col-12 col-sm-12 col-md-12 col-lg-12">\n' +
                    '            <br>\n' +
                    '            <a>Uniform Variables:</a>\n' +
                    '        </div>\n' +
                    '    </div>\n';
                for (var j = 0; j < program.uniforms.length; j++) {
                    if (!window.uniform_counter)
                        window.uniform_counter = 0;
                    var new_uniform_index = window.uniform_counter++;
                    var uniform = program.uniforms[j];
                    var uniform_identifier = program_identifier + "_uniform_" + new_uniform_index;
                    this.pipeline.programs[i].uniforms[j].identifier = uniform_identifier;
                    uniform.identifier = uniform_identifier;
                    html += '    <div id="' + uniform_identifier + '" \n' +
                        '        style="margin:14px; padding-top: 14px; padding-bottom: 14px;text-align:center; color:#fff; font-size: 14px !important; width:auto; background-color: rgba(0,0,0,.75); border-radius: 12px; border: 1px solid #fff !important;">\n' +
                        '\n' +
                        '        <div class="row">\n' +
                        '            <div class="col-12 col-sm-12 col-md-6 col-lg-6" style="align-self: center;">\n' +
                        '                <a>Uniform Identifier:</a>\n' +
                        '                <br>\n' +
                        '                <br>\n' +
                        '            </div>\n' +
                        '            <div class="col-12 col-sm-12 col-md-6 col-lg-6">\n' +
                        '                <input id="' + uniform_identifier + '_name" style="width:inherit; text-align:center; color:#fff;" placeholder="uniform name..."\n' +
                        '                    value="' + uniform.name + '"></input>\n' +
                        '                <br>\n' +
                        '                <br>\n' +
                        '\n' +
                        '            </div>\n' +
                        '        </div>\n' +
                        '        <br>\n' +
                        '        <div class="row">\n' +
                        '            <div class="col-12 col-sm-12 col-md-12 col-lg-12">\n' +
                        '                <a>Uniform Type:</a>\n' +
                        '                <br>\n' +
                        '                <br>\n' +
                        '            </div>\n' +
                        '        </div>\n' +
                        '        <div class="row" style="text-align: right;">\n' +
                        '            <div class="col-6 col-sm-2 col-md-2 col-lg-2" style="align-self: flex-end; text-align: right">\n' +
                        '                <a>float</a>\n' +
                        '            </div>\n' +
                        '            <div class="col-6 col-sm-2 col-md-2 col-lg-2">\n' +
                        '                <div class="checkbox">\n' +
                        '                    <input style="float:right;" id="' + uniform_identifier + '_type_float" type="checkbox" value="">\n' +
                        '                    <label for="' + uniform_identifier + '_type_float"></label>\n' +
                        '                </div>\n' +
                        '            </div>\n' +
                        '            <div class="col-6 col-sm-2 col-md-2 col-lg-2" style="align-self: flex-end; text-align: right">\n' +
                        '                <a>int</a>\n' +
                        '            </div>\n' +
                        '            <div class="col-6 col-sm-2 col-md-2 col-lg-2">\n' +
                        '                <div class="checkbox">\n' +
                        '                    <input style="float:right;" id="' + uniform_identifier + '_type_int" type="checkbox" value="">\n' +
                        '                    <label for="' + uniform_identifier + '_type_int"></label>\n' +
                        '                </div>\n' +
                        '            </div>\n' +
                        '            <div class="col-6 col-sm-2 col-md-2 col-lg-2" style="align-self: flex-end; text-align: right">\n' +
                        '                <a>bool</a>\n' +
                        '            </div>\n' +
                        '            <div class="col-6 col-sm-2 col-md-2 col-lg-2">\n' +
                        '                <div class="checkbox">\n' +
                        '                    <input style="float:right;" id="' + uniform_identifier + '_type_bool" type="checkbox" value="">\n' +
                        '                    <label for="' + uniform_identifier + '_type_"></label>\n' +
                        '                </div>\n' +
                        '            </div>\n' +
                        '            <div class="col-6 col-sm-2 col-md-2 col-lg-2" style="align-self: flex-end; text-align: right">\n' +
                        '                <a>vec2</a>\n' +
                        '            </div>\n' +
                        '            <div class="col-6 col-sm-2 col-md-2 col-lg-2">\n' +
                        '                <div class="checkbox">\n' +
                        '                    <input style="float:right;" id="' + uniform_identifier + '_type_vec2" type="checkbox" value="">\n' +
                        '                    <label for="' + uniform_identifier + '_type_vec2"></label>\n' +
                        '                </div>\n' +
                        '            </div>\n' +
                        '            <div class="col-6 col-sm-2 col-md-2 col-lg-2" style="align-self: flex-end; text-align: right">\n' +
                        '                <a>vec3</a>\n' +
                        '            </div>\n' +
                        '            <div class="col-6 col-sm-2 col-md-2 col-lg-2">\n' +
                        '                <div class="checkbox">\n' +
                        '                    <input style="float:right;" id="' + uniform_identifier + '_type_vec3" type="checkbox" value="">\n' +
                        '                    <label for="' + uniform_identifier + '_type_vec3"></label>\n' +
                        '                </div>\n' +
                        '            </div>\n' +
                        '            <div class="col-6 col-sm-2 col-md-2 col-lg-2" style="align-self: flex-end; text-align: right">\n' +
                        '                <a>vec4</a>\n' +
                        '            </div>\n' +
                        '            <div class="col-6 col-sm-2 col-md-2 col-lg-2">\n' +
                        '                <div class="checkbox">\n' +
                        '                    <input style="float:right;" id="' + uniform_identifier + '_type_vec4" type="checkbox" value="">\n' +
                        '                    <label for="' + uniform_identifier + '_type_vec4"></label>\n' +
                        '                </div>\n' +
                        '            </div>\n' +
                        '            <div class="col-6 col-sm-2 col-md-2 col-lg-2" style="align-self: flex-end; text-align: right">\n' +
                        '                <a>ivec2</a>\n' +
                        '            </div>\n' +
                        '            <div class="col-6 col-sm-2 col-md-2 col-lg-2">\n' +
                        '                <div class="checkbox">\n' +
                        '                    <input style="float:right;" id="' + uniform_identifier + '_type_ivec2" type="checkbox" value="">\n' +
                        '                    <label for="' + uniform_identifier + '_type_ivec2"></label>\n' +
                        '                </div>\n' +
                        '            </div>\n' +
                        '            <div class="col-6 col-sm-2 col-md-2 col-lg-2" style="align-self: flex-end; text-align: right">\n' +
                        '                <a>ivec3</a>\n' +
                        '            </div>\n' +
                        '            <div class="col-6 col-sm-2 col-md-2 col-lg-2">\n' +
                        '                <div class="checkbox">\n' +
                        '                    <input style="float:right;" id="' + uniform_identifier + '_type_ivec3" type="checkbox" value="">\n' +
                        '                    <label for="' + uniform_identifier + '_type_ivec3"></label>\n' +
                        '                </div>\n' +
                        '            </div>\n' +
                        '            <div class="col-6 col-sm-2 col-md-2 col-lg-2" style="align-self: flex-end; text-align: right">\n' +
                        '                <a>ivec4</a>\n' +
                        '            </div>\n' +
                        '            <div class="col-6 col-sm-2 col-md-2 col-lg-2">\n' +
                        '                <div class="checkbox">\n' +
                        '                    <input style="float:right;" id="' + uniform_identifier + '_type_ivec4" type="checkbox" value="">\n' +
                        '                    <label for="' + uniform_identifier + '_type_ivec4"></label>\n' +
                        '                </div>\n' +
                        '            </div>\n' +
                        '            <div class="col-6 col-sm-2 col-md-2 col-lg-2" style="align-self: flex-end; text-align: right">\n' +
                        '                <a>bvec2</a>\n' +
                        '            </div>\n' +
                        '            <div class="col-6 col-sm-2 col-md-2 col-lg-2">\n' +
                        '                <div class="checkbox">\n' +
                        '                    <input style="float:right;" id="' + uniform_identifier + '_type_bvec2" type="checkbox" value="">\n' +
                        '                    <label for="' + uniform_identifier + '_type_bvec2"></label>\n' +
                        '                </div>\n' +
                        '            </div>\n' +
                        '            <div class="col-6 col-sm-2 col-md-2 col-lg-2" style="align-self: flex-end; text-align: right">\n' +
                        '                <a>bvec3</a>\n' +
                        '            </div>\n' +
                        '            <div class="col-6 col-sm-2 col-md-2 col-lg-2">\n' +
                        '                <div class="checkbox">\n' +
                        '                    <input style="float:right;" id="' + uniform_identifier + '_type_bvec3" type="checkbox" value="">\n' +
                        '                    <label for="' + uniform_identifier + '_type_bvec3"></label>\n' +
                        '                </div>\n' +
                        '            </div>\n' +
                        '            <div class="col-6 col-sm-2 col-md-2 col-lg-2" style="align-self: flex-end; text-align: right">\n' +
                        '                <a>bvec4</a>\n' +
                        '            </div>\n' +
                        '            <div class="col-6 col-sm-2 col-md-2 col-lg-2">\n' +
                        '                <div class="checkbox">\n' +
                        '                    <input style="float:right;" id="' + uniform_identifier + '_type_bvec4" type="checkbox" value="">\n' +
                        '                    <label for="' + uniform_identifier + '_type_bvec4"></label>\n' +
                        '                </div>\n' +
                        '            </div>\n' +
                        '            <div class="col-6 col-sm-2 col-md-2 col-lg-2" style="align-self: flex-end; text-align: right">\n' +
                        '                <a>mat2</a>\n' +
                        '            </div>\n' +
                        '            <div class="col-6 col-sm-2 col-md-2 col-lg-2">\n' +
                        '                <div class="checkbox">\n' +
                        '                    <input style="float:right;" id="' + uniform_identifier + '_type_mat2" type="checkbox" value="">\n' +
                        '                    <label for="' + uniform_identifier + '_type_mat2"></label>\n' +
                        '                </div>\n' +
                        '            </div>\n' +
                        '            <div class="col-6 col-sm-2 col-md-2 col-lg-2" style="align-self: flex-end; text-align: right">\n' +
                        '                <a>mat3</a>\n' +
                        '            </div>\n' +
                        '            <div class="col-6 col-sm-2 col-md-2 col-lg-2">\n' +
                        '                <div class="checkbox">\n' +
                        '                    <input style="float:right;" id="' + uniform_identifier + '_type_mat3" type="checkbox" value="">\n' +
                        '                    <label for="' + uniform_identifier + '_type_mat3"></label>\n' +
                        '                </div>\n' +
                        '            </div>\n' +
                        '            <div class="col-6 col-sm-2 col-md-2 col-lg-2" style="align-self: flex-end; text-align: right">\n' +
                        '                <a>mat4</a>\n' +
                        '            </div>\n' +
                        '            <div class="col-6 col-sm-2 col-md-2 col-lg-2">\n' +
                        '                <div class="checkbox">\n' +
                        '                    <input style="float:right;" id="' + uniform_identifier + '_type_mat4" type="checkbox" value="">\n' +
                        '                    <label for="' + uniform_identifier + '_type_mat4"></label>\n' +
                        '                </div>\n' +
                        '            </div>\n' +
                        '            <div class="col-6 col-sm-2 col-md-2 col-lg-2" style="align-self: flex-end; text-align: right">\n' +
                        '                <a>sampler2d</a>\n' +
                        '            </div>\n' +
                        '            <div class="col-6 col-sm-2 col-md-2 col-lg-2">\n' +
                        '                <div class="checkbox">\n' +
                        '                    <input style="float:right;" id="' + uniform_identifier + '_type_sampler2d" type="checkbox" value="">\n' +
                        '                    <label for="' + uniform_identifier + '_type_sampler2d"></label>\n' +
                        '                </div>\n' +
                        '            </div>\n' +
                        '            <div class="col-6 col-sm-2 col-md-2 col-lg-2" style="align-self: flex-end; text-align: right">\n' +
                        '                <a>samplercube</a>\n' +
                        '            </div>\n' +
                        '            <div class="col-6 col-sm-2 col-md-2 col-lg-2">\n' +
                        '                <div class="checkbox">\n' +
                        '                    <input style="float:right;" id="' + uniform_identifier + '_type_samplercube" type="checkbox" value="">\n' +
                        '                    <label for="' + uniform_identifier + '_type_samplercube"></label>\n' +
                        '                </div>\n' +
                        '            </div>\n' +
                        '        </div>\n' +
                        '        <br>\n' +
                        '        <div class="row">\n' +
                        '            <div class="col-12 col-sm-12 col-md-12 col-lg-12">\n' +
                        '                <a>Uniform Value:</a>\n' +
                        '                <br>\n' +
                        '                <br>\n' +
                        '            </div>\n' +
                        '        </div>\n' +
                        '        <div class="row">\n' +
                        '            <div class="col-12 col-sm-12 col-md-12 col-lg-12">\n' +
                        '                <textarea id="' + uniform_identifier + '_js_code" rows="8"\n' +
                        '                    style="text-align:left; border: 1px solid #FFF;"\n' +
                        '                    placeholder="Enter JavaScript here..." value=""></textarea>\n' +
                        '            </div>\n' +
                        '            <br>\n' +
                        '        </div>\n' +
                        '        <br>\n' +
                        '    <div class="row">\n' +
                        '        <div class="col-6 col-sm-6 col-md-6 col-lg-6">\n' +
                        '            <button type="button" ' + (j == 0 ? "disabled" : "onclick='state.move_uniform_up(" + i + ", " + j + ")'") + ' id="' + uniform_identifier + '_move_up" class="btn btn-outline-warning mx-auto">Move Uniform Up</button>\n' +
                        '            <br>\n' +
                        '        </div>\n' +
                        '        <div class="col-6 col-sm-6 col-md-6 col-lg-6">\n' +
                        '            <button type="button" ' + (j == program.uniforms.length - 1 ? "disabled" : "onclick='state.move_uniform_down(" + i + ", " + j + ")'") + ' id="' + uniform_identifier + '_move_down" class="btn btn-outline-warning mx-auto">Move Uniform Down</button>\n' +
                        '            <br>\n' +
                        '        </div>\n' +
                        '    </div>\n' +
                        '    <br>\n' +
                        '\n' +
                        '\n' +
                        '    <div class="row">\n' +
                        '        <div class="col-6 col-sm-6 col-md-6 col-lg-6">\n' +
                        '            <button type="button" ' + ("onclick='state.duplicate_uniform(" + i + ", " + j + ")'") + ' id="' + uniform_identifier + '_duplicate" class="btn btn-outline-primary mx-auto">Duplicate Uniform</button>\n' +
                        '            <br>\n' +
                        '        </div>\n' +
                        '        <div class="col-6 col-sm-6 col-md-6 col-lg-6">\n' +
                        '            <button type="button" ' + ("onclick='state.delete_uniform(" + i + ", " + j + ")'") + ' id="' + uniform_identifier + '_delete" class="btn btn-outline-danger mx-auto">Delete Uniform</button>\n' +
                        '            <br>\n' +
                        '        </div>\n' +
                        '    </div>\n' +
                        '    </div>\n' +
                        '        <br>\n';
                }
                html += '        <div class="row">\n' +
                    '            <div class="col-12 col-sm-12 col-md-12 col-lg-12">\n' +
                    '                <button onclick="state.add_uniform(' + i + ')" type="button" class="btn btn-outline-success mx-auto">Add Uniform\n' +
                    '                    Variable</button>\n' +
                    '                <br>\n' +
                    '            </div>\n' +
                    '        </div>\n' +
                    '    </div>\n' +
                    '    <div class="row">\n' +
                    '        <div class="col-12 col-sm-12 col-md-12 col-lg-12">\n' +
                    '            <a>Vertex Shader</a>\n' +
                    '            <br>\n' +
                    '            <br>\n' +
                    '        </div>\n' +
                    '    </div>\n' +
                    '    <div class="row">\n' +
                    '        <div class="col-12 col-sm-12 col-md-12 col-lg-12">\n' +
                    '            <textarea id="' + program_identifier + '_vertex_code" rows="8" style="text-align:left; border: 1px solid #FFF;"\n' +
                    '                placeholder="Enter JavaScript here..."\n' +
                    '                value=""></textarea>\n' +
                    '        </div>\n' +
                    '        <br>\n' +
                    '    </div>\n' +
                    '    <br>\n' +
                    '    <div class="row">\n' +
                    '        <div class="col-12 col-sm-12 col-md-12 col-lg-12">\n' +
                    '            <a>Fragment Shader:</a>\n' +
                    '            <br>\n' +
                    '            <br>\n' +
                    '        </div>\n' +
                    '    </div>\n' +
                    '    <div class="row">\n' +
                    '        <div class="col-12 col-sm-12 col-md-12 col-lg-12">\n' +
                    '            <textarea id="' + program_identifier + '_fragment_code" rows="8" style="text-align:left; border: 1px solid #FFF;"\n' +
                    '                placeholder="Enter JavaScript here..."\n' +
                    '                value=""></textarea>\n' +
                    '        </div>\n' +
                    '        <br>\n' +
                    '    </div>\n' +
                    '    <br>\n' +
                    '\n' +
                    '\n' +
                    '\n' +
                    '\n' +
                    '    <div class="row">\n' +
                    '        <div class="col-6 col-sm-6 col-md-6 col-lg-6">\n' +
                    '            <button type="button" ' + (i == 0 ? "disabled" : "onclick='state.move_program_up(" + i + ")'") + ' id="' + program_identifier + '_move_up" class="btn btn-outline-warning mx-auto">Move Program Up</button>\n' +
                    '            <br>\n' +
                    '        </div>\n' +
                    '        <div class="col-6 col-sm-6 col-md-6 col-lg-6">\n' +
                    '            <button type="button" ' + (i == programs.length - 1 ? "disabled" : "onclick='state.move_program_down(" + i + ")'") + ' id="' + program_identifier + '_move_down" class="btn btn-outline-warning mx-auto">Move Program Down</button>\n' +
                    '            <br>\n' +
                    '        </div>\n' +
                    '    </div>\n' +
                    '    <br>\n' +
                    '\n' +
                    '\n' +
                    '    <div class="row">\n' +
                    '        <div class="col-6 col-sm-6 col-md-6 col-lg-6">\n' +
                    '            <button type="button" ' + ("onclick='state.duplicate_program(" + i + ")'") + ' id="' + program_identifier + '_duplicate" class="btn btn-outline-primary mx-auto">Duplicate Program</button>\n' +
                    '            <br>\n' +
                    '        </div>\n' +
                    '        <div class="col-6 col-sm-6 col-md-6 col-lg-6">\n' +
                    '            <button type="button" ' + ("onclick='state.delete_program(" + i + ")'") + ' id="' + program_identifier + '_delete" class="btn btn-outline-danger mx-auto">Delete Program</button>\n' +
                    '            <br>\n' +
                    '        </div>\n' +
                    '    </div>\n' +
                    '</h1>';
            }
            $(window.location.hash + "_algorithm_programs").html(html);

            this.program_codemirrors = [];

            for (var i = 0; i < programs.length; i++) {
                var program = programs[i];
                var program_identifier = program.identifier;

                this.program_codemirrors.push([]);

                frag_editor = CodeMirror.fromTextArea(document.getElementById(program_identifier + '_fragment_code'), { autoRefresh: true, lineWrapping: true, lineNumbers: true, viewPortMargin: Infinity, theme: 'the-matrix height-auto', mode: 'x-shader/x-vertex' })
                frag_editor.getWrapperElement().id = program_identifier + '_fragment_code_editor';
                frag_editor.setValue(program.fragment ? program.fragment : "");
                this.program_codemirrors[i].push(frag_editor);

                vert_editor = CodeMirror.fromTextArea(document.getElementById(program_identifier + '_vertex_code'), { autoRefresh: true, lineWrapping: true, lineNumbers: true, viewPortMargin: Infinity, theme: 'the-matrix height-auto', mode: 'x-shader/x-fragment' })
                frag_editor.getWrapperElement().id = program_identifier + '_vertex_code_editor';
                vert_editor.setValue(program.vertex ? program.vertex : "");
                this.program_codemirrors[i].push(vert_editor);

                for (var j = 0; j < program.uniforms.length; j++) {
                    var uniform = program.uniforms[j];
                    var uniform_identifier = uniform.identifier;

                    this.mutex_checkboxes([uniform_identifier + '_type_float',
                    uniform_identifier + '_type_int',
                    uniform_identifier + '_type_bool',
                    uniform_identifier + '_type_vec2',
                    uniform_identifier + '_type_vec3',
                    uniform_identifier + '_type_vec4',
                    uniform_identifier + '_type_ivec2',
                    uniform_identifier + '_type_ivec3',
                    uniform_identifier + '_type_ivec4',
                    uniform_identifier + '_type_bvec2',
                    uniform_identifier + '_type_bvec3',
                    uniform_identifier + '_type_bvec4',
                    uniform_identifier + '_type_mat2',
                    uniform_identifier + '_type_mat3',
                    uniform_identifier + '_type_mat4',
                    uniform_identifier + '_type_sampler2d',
                    uniform_identifier + '_type_samplercube'], null);

                    if (uniform.type == OpenGLUniform.Type.FLOAT)
                        $("#" + uniform_identifier + '_type_float').prop("checked", false).click();
                    if (uniform.type == OpenGLUniform.Type.INT)
                        $("#" + uniform_identifier + '_type_int').prop("checked", false).click();
                    if (uniform.type == OpenGLUniform.Type.BOOL)
                        $("#" + uniform_identifier + '_type_bool').prop("checked", false).click();
                    if (uniform.type == OpenGLUniform.Type.VEC_TWO)
                        $("#" + uniform_identifier + '_type_vec2').prop("checked", false).click();
                    if (uniform.type == OpenGLUniform.Type.VEC_THREE)
                        $("#" + uniform_identifier + '_type_vec3').prop("checked", false).click();
                    if (uniform.type == OpenGLUniform.Type.VEC_FOUR)
                        $("#" + uniform_identifier + '_type_vec4').prop("checked", false).click();
                    if (uniform.type == OpenGLUniform.Type.IVEC_TWO)
                        $("#" + uniform_identifier + '_type_ivec2').prop("checked", false).click();
                    if (uniform.type == OpenGLUniform.Type.IVEC_THREE)
                        $("#" + uniform_identifier + '_type_ivec3').prop("checked", false).click();
                    if (uniform.type == OpenGLUniform.Type.IVEC_FOUR)
                        $("#" + uniform_identifier + '_type_ivec4').prop("checked", false).click();
                    if (uniform.type == OpenGLUniform.Type.BVEC_TWO)
                        $("#" + uniform_identifier + '_type_bvec2').prop("checked", false).click();;
                    if (uniform.type == OpenGLUniform.Type.BVEC_THREE)
                        $("#" + uniform_identifier + '_type_bvec3').prop("checked", false).click();;
                    if (uniform.type == OpenGLUniform.Type.BVEC_FOUR)
                        $("#" + uniform_identifier + '_type_bvec4').prop("checked", false).click();;
                    if (uniform.type == OpenGLUniform.Type.MAT_TWO)
                        $("#" + uniform_identifier + '_type_mat2').prop("checked", false).click();;
                    if (uniform.type == OpenGLUniform.Type.MAT_THREE)
                        $("#" + uniform_identifier + '_type_mat3').prop("checked", false).click();;
                    if (uniform.type == OpenGLUniform.Type.MAT_FOUR)
                        $("#" + uniform_identifier + '_type_mat4').prop("checked", false).click();;
                    if (uniform.type == OpenGLUniform.Type.SAMPLER_TWO_D)
                        $("#" + uniform_identifier + '_type_sampler2d').prop("checked", false).click();;
                    if (uniform.type == OpenGLUniform.Type.SAMPLERCUBE)
                        $("#" + uniform_identifier + '_type_samplercube').prop("checked", false).click();;

                    uniform_js_editor = CodeMirror.fromTextArea(document.getElementById(uniform_identifier + '_js_code'), { autoRefresh: true, lineWrapping: true, lineNumbers: true, viewPortMargin: Infinity, theme: 'the-matrix height-auto', mode: 'javascript' })
                    uniform_js_editor.getWrapperElement().id = uniform_identifier + '_js_code_editor';
                    uniform_js_editor.setValue(uniform.value);
                    this.program_codemirrors[i].push(uniform_js_editor);
                }
            }
        }

        GlobalState.prototype.get_ui_programs = function () {
            var ui_programs = [];
            for (var i = 0; i < this.pipeline.programs.length; i++) {
                var program = this.pipeline.programs[i];
                var program_identifier = program.identifier;
                console.log(program_identifier);
                var ui_program = OpenGLProgram.fromObject(JSON.parse(JSON.stringify(program)));

                ui_program.name = $("#" + program_identifier + '_name').val();

                ui_program.fragment = this.program_codemirrors[i][0].getValue()
                ui_program.vertex = this.program_codemirrors[i][1].getValue()

                ui_program.uniforms = this.get_ui_uniforms(i);

                ui_programs.push(ui_program);
            }
            return ui_programs;
        }


        GlobalState.prototype.add_program = function (new_program = default_algorithm_program) {
            new_program = OpenGLProgram.fromObject(JSON.parse(JSON.stringify(new_program)));

            var ui_programs = this.get_ui_programs();

            ui_programs.push(new_program);
            this.pipeline.programs.push(new_program);
            this.render_programs(ui_programs);
        }

        GlobalState.prototype.delete_program = function (index) {
            var ui_programs = this.get_ui_programs();

            ui_programs.splice(index, 1);
            this.pipeline.programs.splice(index, 1);
            this.render_programs(ui_programs);
        }

        GlobalState.prototype.duplicate_program = function (index) {
            var ui_programs = this.get_ui_programs();
            new_program = OpenGLProgram.fromObject(JSON.parse(JSON.stringify(ui_programs[index])));

            ui_programs.push(new_program);
            this.pipeline.programs.push(new_program);
            this.render_programs(ui_programs);
        }
        GlobalState.prototype.move_program_up = function (index) {
            var ui_programs = this.get_ui_programs();

            var new_programs = [];

            new_programs = new_programs.concat(ui_programs.splice(0, index - 1));
            var moving_program = ui_programs.splice(0, 1);
            new_programs = new_programs.concat(ui_programs.splice(0, 1));
            new_programs = new_programs.concat(moving_program);
            new_programs = new_programs.concat(ui_programs);

            this.pipeline.programs = new_programs;
            this.render_programs(new_programs);
        }
        GlobalState.prototype.move_program_down = function (index) {
            var ui_programs = this.get_ui_programs();

            var new_programs = [];

            new_programs = new_programs.concat(ui_programs.splice(0, index));
            var moving_program = ui_programs.splice(0, 1);
            new_programs = new_programs.concat(ui_programs.splice(0, 1));
            new_programs = new_programs.concat(moving_program);
            new_programs = new_programs.concat(ui_programs);

            this.pipeline.programs = new_programs;
            this.render_programs(new_programs);
        }


        GlobalState.prototype.get_ui_uniforms = function (program_index) {
            var program = this.pipeline.programs[program_index];
            var program_uniforms = [];
            for (var j = 0; j < program.uniforms.length; j++) {
                var uniform = program.uniforms[j];
                var uniform_identifier = uniform.identifier;
                uniform.name = $("#" + uniform_identifier + '_name').val();

                if ($("#" + uniform_identifier + '_type_float').prop("checked"))
                    uniform.type = OpenGLUniform.Type.FLOAT;
                if ($("#" + uniform_identifier + '_type_int').prop("checked"))
                    uniform.type = OpenGLUniform.Type.INT;
                if ($("#" + uniform_identifier + '_type_bool').prop("checked"))
                    uniform.type = OpenGLUniform.Type.BOOL;
                if ($("#" + uniform_identifier + '_type_vec2').prop("checked"))
                    uniform.type = OpenGLUniform.Type.VEC_TWO;
                if ($("#" + uniform_identifier + '_type_vec3').prop("checked"))
                    uniform.type = OpenGLUniform.Type.VEC_THREE;
                if ($("#" + uniform_identifier + '_type_vec4').prop("checked"))
                    uniform.type = OpenGLUniform.Type.VEC_FOUR;
                if ($("#" + uniform_identifier + '_type_ivec2').prop("checked"))
                    uniform.type = OpenGLUniform.Type.IVEC_TWO;
                if ($("#" + uniform_identifier + '_type_ivec3').prop("checked"))
                    uniform.type = OpenGLUniform.Type.IVEC_THREE;
                if ($("#" + uniform_identifier + '_type_ivec4').prop("checked"))
                    uniform.type = OpenGLUniform.Type.IVEC_FOUR;
                if ($("#" + uniform_identifier + '_type_bvec2').prop("checked"))
                    uniform.type = OpenGLUniform.Type.BVEC_TWO;
                if ($("#" + uniform_identifier + '_type_bvec3').prop("checked"))
                    uniform.type = OpenGLUniform.Type.BVEC_THREE;
                if ($("#" + uniform_identifier + '_type_bvec4').prop("checked"))
                    uniform.type = OpenGLUniform.Type.BVEC_FOUR;
                if ($("#" + uniform_identifier + '_type_mat2').prop("checked"))
                    uniform.type = OpenGLUniform.Type.MAT_TWO;
                if ($("#" + uniform_identifier + '_type_mat3').prop("checked"))
                    uniform.type = OpenGLUniform.Type.MAT_THREE;
                if ($("#" + uniform_identifier + '_type_mat4').prop("checked"))
                    uniform.type = OpenGLUniform.Type.MAT_FOUR;
                if ($("#" + uniform_identifier + '_type_sampler2d').prop("checked"))
                    uniform.type = OpenGLUniform.Type.SAMPLER_TWO_D;
                if ($("#" + uniform_identifier + '_type_samplercube').prop("checked"))
                    uniform.type = OpenGLUniform.Type.SAMPLERCUBE;

                uniform.value = this.program_codemirrors[program_index][j + 2].getValue()
                program_uniforms.push(uniform);
            }
            return program_uniforms;
        }

        GlobalState.prototype.add_uniform = function (program_index, new_uniform = default_algorithm_uniform) {
            new_uniform = OpenGLUniform.fromObject(JSON.parse(JSON.stringify(new_uniform)));

            var ui_programs = this.get_ui_programs();

            ui_programs[program_index].uniforms.push(new_uniform);
            this.pipeline.programs[program_index].uniforms.push(new_uniform)
            this.render_programs(ui_programs);
        }

        GlobalState.prototype.delete_uniform = function (program_index, uniform_index) {
            var ui_programs = this.get_ui_programs();

            ui_programs[program_index].uniforms.splice(uniform_index, 1);
            this.pipeline.programs[program_index].uniforms.splice(uniform_index, 1);
            this.render_programs(ui_programs);
        }

        GlobalState.prototype.duplicate_uniform = function (program_index, uniform_index) {
            var ui_programs = this.get_ui_programs();
            new_uniform = OpenGLUniform.fromObject(JSON.parse(JSON.stringify(ui_programs[program_index].uniforms[uniform_index])));

            ui_programs[program_index].uniforms.push(new_uniform);
            this.pipeline.programs[program_index].uniforms.push(new_uniform)
            this.render_programs(ui_programs);
        }
        GlobalState.prototype.move_uniform_up = function (program_index, uniform_index) {
            var ui_programs = this.get_ui_programs();

            var new_uniforms = [];

            new_uniforms = new_uniforms.concat(ui_programs[program_index].uniforms.splice(0, uniform_index - 1));
            var moving_uniform = ui_programs[program_index].uniforms.splice(0, 1);
            new_uniforms = new_uniforms.concat(ui_programs[program_index].uniforms.splice(0, 1));
            new_uniforms = new_uniforms.concat(moving_uniform);
            new_uniforms = new_uniforms.concat(ui_programs[program_index].uniforms);

            ui_programs[program_index].uniforms = new_uniforms;
            this.pipeline.programs[program_index].uniforms = new_uniforms;
            this.render_programs(ui_programs);
        }
        GlobalState.prototype.move_uniform_down = function (program_index, uniform_index) {
            var ui_programs = this.get_ui_programs();

            var new_uniforms = [];

            new_uniforms = new_uniforms.concat(ui_programs[program_index].uniforms.splice(0, uniform_index));
            var moving_uniform = ui_programs[program_index].uniforms.splice(0, 1);
            new_uniforms = new_uniforms.concat(ui_programs[program_index].uniforms.splice(0, 1));
            new_uniforms = new_uniforms.concat(moving_uniform);
            new_uniforms = new_uniforms.concat(ui_programs[program_index].uniforms);

            ui_programs[program_index].uniforms = new_uniforms;
            this.pipeline.programs[program_index].uniforms = new_uniforms;
            this.render_programs(ui_programs);
        }

        GlobalState.prototype.add_stage = function (new_stage = default_algorithm_stage) {
            new_stage = OpenGLStage.fromObject(JSON.parse(JSON.stringify(new_stage)));

            var ui_stages = this.get_ui_stages();

            ui_stages.push(new_stage);
            this.pipeline.stages.push(new_stage);
            this.render_stages(ui_stages);
        }

        GlobalState.prototype.delete_stage = function (index) {
            var ui_stages = this.get_ui_stages();

            ui_stages.splice(index, 1);
            this.pipeline.stages.splice(index, 1);
            this.render_stages(ui_stages);
        }

        GlobalState.prototype.duplicate_stage = function (index) {
            var ui_stages = this.get_ui_stages();
            new_stage = OpenGLStage.fromObject(JSON.parse(JSON.stringify(ui_stages[index])));

            ui_stages.push(new_stage);
            this.pipeline.stages.push(new_stage);
            this.render_stages(ui_stages);
        }
        GlobalState.prototype.move_stage_up = function (index) {
            var ui_stages = this.get_ui_stages();

            var new_stages = [];

            new_stages = new_stages.concat(ui_stages.splice(0, index - 1));
            var moving_stage = ui_stages.splice(0, 1);
            new_stages = new_stages.concat(ui_stages.splice(0, 1));
            new_stages = new_stages.concat(moving_stage);
            new_stages = new_stages.concat(ui_stages);

            this.pipeline.stages = new_stages;
            this.render_stages(new_stages);
        }
        GlobalState.prototype.move_stage_down = function (index) {
            var ui_stages = this.get_ui_stages();

            var new_stages = [];

            new_stages = new_stages.concat(ui_stages.splice(0, index));
            var moving_stage = ui_stages.splice(0, 1);
            new_stages = new_stages.concat(ui_stages.splice(0, 1));
            new_stages = new_stages.concat(moving_stage);
            new_stages = new_stages.concat(ui_stages);

            this.pipeline.stages = new_stages;
            this.render_stages(new_programs);
        }
        GlobalState.prototype.render_stages = function (stages) {
            var html = "";
            for (var i = 0; i < stages.length; i++) {
                var stage = stages[i];

                if (!window.stage_counter)
                    window.stage_counter = 0;
                var new_stage_index = window.stage_counter++;

                var name_prefix = window.location.hash.substring(1) + "_stage_identifier_";
                var stage_identifier = name_prefix + new_stage_index;
                this.pipeline.stages[i].identifier = stage_identifier;
                stage.identifier = stage_identifier;

                html += '<h1 class="editable" id="' + stage_identifier + '"\n' +
                    '    style="padding-top: 14px; padding-bottom: 14px;text-align:center; color:#fff; font-size: 14px !important; width:auto; background-color: rgba(0,0,0,.75); border-radius: 12px; border: 1px solid #fff !important;">\n' +
                    '    <div class="row">\n' +
                    '        <div class="col-12 col-sm-12 col-md-6 col-lg-6" style="align-self: center;">\n' +
                    '            <a>Stage Identifier:</a>\n' +
                    '            <br>\n' +
                    '            <br>\n' +
                    '        </div>\n' +
                    '        <div class="col-12 col-sm-12 col-md-6 col-lg-6">\n' +
                    '            <input id="' + stage_identifier + '_name" style="width:inherit; text-align:center; color:#fff;" placeholder="Program name..."\n' +
                    '                value="' + stage.name + '""></input>\n' +
                    '            <br>\n' +
                    '            <br>\n' +
                    '\n' +
                    '        </div>\n' +
                    '    </div>\n' +
                    '    <br>\n' +
                    '    <div class="row">\n' +
                    '        <div class="col-12 col-sm-12 col-md-6 col-lg-6" style="align-self: center;">\n' +
                    '            <a>Linked Context Identifier:</a>\n' +
                    '            <br>\n' +
                    '            <br>\n' +
                    '        </div>\n' +
                    '        <div class="col-12 col-sm-12 col-md-6 col-lg-6">\n' +
                    '            <input style="width:inherit; text-align:center; color:#fff;" placeholder="Context name..."\n' +
                    '                id="' + stage_identifier + '_context_name" value="' + stage.context + '"></input>\n' +
                    '            <br>\n' +
                    '            <br>\n' +
                    '\n' +
                    '        </div>\n' +
                    '    </div>\n' +
                    '    <br>\n' +
                    '    <div class="row">\n' +
                    '        <div class="col-12 col-sm-12 col-md-6 col-lg-6" style="align-self: center;">\n' +
                    '            <a>Linked Program Identifier:</a>\n' +
                    '            <br>\n' +
                    '            <br>\n' +
                    '        </div>\n' +
                    '        <div class="col-12 col-sm-12 col-md-6 col-lg-6">\n' +
                    '            <input style="width:inherit; text-align:center; color:#fff;" placeholder="Program name..."\n' +
                    '                id="' + stage_identifier + '_program_name" value="' + stage.program + '"></input>\n' +
                    '            <br>\n' +
                    '            <br>\n' +
                    '\n' +
                    '        </div>\n' +
                    '    </div>\n' +
                    '    <br>\n' +
                    '    <div class="row" style="border-top: 1px solid #fff;">\n' +
                    '        <div class="col-12 col-sm-12 col-md-12 col-lg-12">\n' +
                    '            <br>\n' +
                    '            <a>Stage Type:</a>\n' +
                    '            <br>\n' +
                    '            <br>\n' +
                    '        </div>\n' +
                    '    </div>\n' +
                    '    <br>\n' +
                    '    <div class="row">\n' +
                    '        <div class="col-6 col-sm-6 col-md-6 col-lg-6" style="align-self: flex-end; text-align: right;">\n' +
                    '            <a>Shader</a>\n' +
                    '        </div>\n' +
                    '        <div class="col-2 col-sm-2 col-md-2 col-lg-2" style="text-align: left;">\n' +
                    '            <div class="checkbox">\n' +
                    '                <input style="float:right;" id="' + stage_identifier + '_stage_shader" type="checkbox" value="">\n' +
                    '                <label for="' + stage_identifier + '_stage_shader"></label>\n' +
                    '            </div>\n' +
                    '        </div>\n' +
                    '        <div class="col-2 col-sm-2 col-md-2 col-lg-2" style="text-align: center;">\n' +
                    '        </div>\n' +
                    '        <div class="col-2 col-sm-2 col-md-2 col-lg-2" style="text-align: center;">\n' +
                    '        </div>\n' +
                    '    </div>\n' +
                    '    <br>\n' +
                    '    <div class="row">\n' +
                    '        <div class="col-6 col-sm-6 col-md-6 col-lg-6" style="align-self: flex-end; text-align: right">\n' +
                    '            <a>Points</a>\n' +
                    '        </div>\n' +
                    '        <div class="col-2 col-sm-2 col-md-2 col-lg-2" style="text-align: left;">\n' +
                    '            <div class="checkbox">\n' +
                    '                <input style="float:right;" id="' + stage_identifier + '_stage_mesh_points" type="checkbox" value="">\n' +
                    '                <label for="' + stage_identifier + '_stage_mesh_points"></label>\n' +
                    '            </div>\n' +
                    '        </div>\n' +
                    '        <div class="col-2 col-sm-2 col-md-2 col-lg-2" style="text-align: center;">\n' +
                    '        </div>\n' +
                    '        <div class="col-2 col-sm-2 col-md-2 col-lg-2" style="text-align: center;">\n' +
                    '        </div>\n' +
                    '    </div>\n' +
                    '    <br>\n' +
                    '    <div class="row">\n' +
                    '        <div class="col-6 col-sm-6 col-md-6 col-lg-6" style="align-self: flex-end; text-align: right">\n' +
                    '            <a>Lines</a>\n' +
                    '        </div>\n' +
                    '        <div class="col-2 col-sm-2 col-md-2 col-lg-2" style="text-align: left;">\n' +
                    '            <div class="checkbox">\n' +
                    '                <input style="float:right;" id="' + stage_identifier + '_stage_mesh_lines" type="checkbox" value="">\n' +
                    '                <label for="' + stage_identifier + '_stage_mesh_lines"></label>\n' +
                    '            </div>\n' +
                    '        </div>\n' +
                    '        <div class="col-2 col-sm-2 col-md-2 col-lg-2" style="text-align: center;">\n' +
                    '        </div>\n' +
                    '        <div class="col-2 col-sm-2 col-md-2 col-lg-2" style="text-align: center;">\n' +
                    '        </div>\n' +
                    '    </div>\n' +
                    '    <br>\n' +
                    '    <div class="row">\n' +
                    '        <div class="col-6 col-sm-6 col-md-6 col-lg-6" style="align-self: flex-end; text-align: right">\n' +
                    '            <a>Line Strip</a>\n' +
                    '        </div>\n' +
                    '        <div class="col-2 col-sm-2 col-md-2 col-lg-2" style="text-align: left;">\n' +
                    '            <div class="checkbox">\n' +
                    '                <input style="float:right;" id="' + stage_identifier + '_stage_mesh_line_strip" type="checkbox" value="">\n' +
                    '                <label for="' + stage_identifier + '_stage_mesh_line_strip"></label>\n' +
                    '            </div>\n' +
                    '        </div>\n' +
                    '        <div class="col-2 col-sm-2 col-md-2 col-lg-2" style="text-align: center;">\n' +
                    '        </div>\n' +
                    '        <div class="col-2 col-sm-2 col-md-2 col-lg-2" style="text-align: center;">\n' +
                    '        </div>\n' +
                    '    </div>\n' +
                    '    <br>\n' +
                    '    <div class="row">\n' +
                    '        <div class="col-6 col-sm-6 col-md-6 col-lg-6" style="align-self: flex-end; text-align: right">\n' +
                    '            <a>Line Loop</a>\n' +
                    '        </div>\n' +
                    '        <div class="col-2 col-sm-2 col-md-2 col-lg-2" style="text-align: left;">\n' +
                    '            <div class="checkbox">\n' +
                    '                <input style="float:right;" id="' + stage_identifier + '_stage_mesh_line_loop" type="checkbox" value="">\n' +
                    '                <label for="' + stage_identifier + '_stage_mesh_line_loop"></label>\n' +
                    '            </div>\n' +
                    '        </div>\n' +
                    '        <div class="col-2 col-sm-2 col-md-2 col-lg-2" style="text-align: center;">\n' +
                    '        </div>\n' +
                    '        <div class="col-2 col-sm-2 col-md-2 col-lg-2" style="text-align: center;">\n' +
                    '        </div>\n' +
                    '    </div>\n' +
                    '    <br>\n' +
                    '    <div class="row">\n' +
                    '        <div class="col-6 col-sm-6 col-md-6 col-lg-6" style="align-self: flex-end; text-align: right">\n' +
                    '            <a>Triangles</a>\n' +
                    '        </div>\n' +
                    '        <div class="col-2 col-sm-2 col-md-2 col-lg-2" style="text-align: left;">\n' +
                    '            <div class="checkbox">\n' +
                    '                <input style="float:right;" id="' + stage_identifier + '_stage_mesh_triangles" type="checkbox" value="">\n' +
                    '                <label for="' + stage_identifier + '_stage_mesh_triangles"></label>\n' +
                    '            </div>\n' +
                    '        </div>\n' +
                    '        <div class="col-2 col-sm-2 col-md-2 col-lg-2" style="text-align: center;">\n' +
                    '        </div>\n' +
                    '        <div class="col-2 col-sm-2 col-md-2 col-lg-2" style="text-align: center;">\n' +
                    '        </div>\n' +
                    '    </div>\n' +
                    '    <br>\n' +
                    '    <div class="row">\n' +
                    '        <div class="col-6 col-sm-6 col-md-6 col-lg-6" style="align-self: flex-end; text-align: right">\n' +
                    '            <a>Triangle Fan</a>\n' +
                    '        </div>\n' +
                    '        <div class="col-2 col-sm-2 col-md-2 col-lg-2" style="text-align: left;">\n' +
                    '            <div class="checkbox">\n' +
                    '                <input style="float:right;" id="' + stage_identifier + '_stage_mesh_triangle_fan" type="checkbox" value="">\n' +
                    '                <label for="' + stage_identifier + '_stage_mesh_triangle_fan"></label>\n' +
                    '            </div>\n' +
                    '        </div>\n' +
                    '        <div class="col-2 col-sm-2 col-md-2 col-lg-2" style="text-align: center;">\n' +
                    '        </div>\n' +
                    '        <div class="col-2 col-sm-2 col-md-2 col-lg-2" style="text-align: center;">\n' +
                    '        </div>\n' +
                    '    </div>\n' +
                    '    <br>\n' +
                    '    <div class="row">\n' +
                    '        <div class="col-6 col-sm-6 col-md-6 col-lg-6" style="align-self: flex-end; text-align: right">\n' +
                    '            <a>Triangle Strip</a>\n' +
                    '        </div>\n' +
                    '        <div class="col-2 col-sm-2 col-md-2 col-lg-2" style="text-align: left;">\n' +
                    '            <div class="checkbox">\n' +
                    '                <input style="float:right;" id="' + stage_identifier + '_stage_mesh_triangle_strip" type="checkbox" value="">\n' +
                    '                <label for="' + stage_identifier + '_stage_mesh_triangle_strip"></label>\n' +
                    '            </div>\n' +
                    '        </div>\n' +
                    '        <div class="col-2 col-sm-2 col-md-2 col-lg-2" style="text-align: center;">\n' +
                    '        </div>\n' +
                    '        <div class="col-2 col-sm-2 col-md-2 col-lg-2" style="text-align: center;">\n' +
                    '        </div>\n' +
                    '    </div>\n' +
                    '    <br>\n' +
                    '    <div class="row" id="' + stage_identifier + '_indices_section">\n' +
                    '        <div class="col-12 col-sm-12 col-md-12 col-lg-12">\n' +
                    '            <a>Mesh Indices Evaluation:</a>\n' +
                    '            <br>\n' +
                    '            <br>\n' +
                    '            <textarea id="' + stage_identifier + '_indices_code" rows="8" style="text-align:left; border: 1px solid #FFF;"\n' +
                    '                placeholder="Enter JavaScript here..."\n' +
                    '                value=""></textarea>\n' +
                    '        </div>\n' +
                    '        <br>\n' +
                    '    </div>\n' +
                    '    <br>\n' +
                    '    <div class="row" id="' + stage_identifier + '_vertices_section">\n' +
                    '        <div class="col-12 col-sm-12 col-md-12 col-lg-12">\n' +
                    '            <a>Mesh Vertices Evaluation:</a>\n' +
                    '            <br>\n' +
                    '            <br>\n' +
                    '            <textarea id="' + stage_identifier + '_vertices_code" rows="8" style="text-align:left; border: 1px solid #FFF;"\n' +
                    '                placeholder="Enter JavaScript here..."\n' +
                    '                value=""></textarea>\n' +
                    '        </div>\n' +
                    '        <br>\n' +
                    '    </div>\n' +
                    '    <br>\n' +
                    '\n' +
                    '    <div class="row">\n' +
                    '        <div class="col-6 col-sm-6 col-md-6 col-lg-6">\n' +
                    '            <button type="button" ' + (i == 0 ? "disabled" : "onclick='state.move_stage_up(" + i + ")'") + ' id="' + stage_identifier + '_move_up" class="btn btn-outline-warning mx-auto">Move Stage Up</button>\n' +
                    '            <br>\n' +
                    '        </div>\n' +
                    '        <div class="col-6 col-sm-6 col-md-6 col-lg-6">\n' +
                    '            <button type="button" ' + (i == stages.length - 1 ? "disabled" : "onclick='state.move_stage_down(" + i + ")'") + ' id="' + stage_identifier + '_move_down" class="btn btn-outline-warning mx-auto">Move Stage Down</button>\n' +
                    '            <br>\n' +
                    '        </div>\n' +
                    '    </div>\n' +
                    '    <br>\n' +
                    '\n' +
                    '\n' +
                    '    <div class="row">\n' +
                    '        <div class="col-6 col-sm-6 col-md-6 col-lg-6">\n' +
                    '            <button type="button" ' + ("onclick='state.duplicate_stage(" + i + ")'") + ' id="' + stage_identifier + '_duplicate" class="btn btn-outline-primary mx-auto">Duplicate Stage</button>\n' +
                    '            <br>\n' +
                    '        </div>\n' +
                    '        <div class="col-6 col-sm-6 col-md-6 col-lg-6">\n' +
                    '            <button type="button" ' + ("onclick='state.delete_stage(" + i + ")'") + ' id="' + stage_identifier + '_delete" class="btn btn-outline-danger mx-auto">Delete Stage</button>\n' +
                    '            <br>\n' +
                    '        </div>\n' +
                    '    </div>\n' +
                    '</h1>';
            }
            $(window.location.hash + "_algorithm_stages").html(html);

            this.stage_codemirrors = [];

            for (var i = 0; i < stages.length; i++) {
                var stage = stages[i];
                var stage_identifier = stage.identifier;

                this.stage_codemirrors.push([]);

                this.mutex_checkboxes([stage_identifier + '_stage_shader',
                stage_identifier + '_stage_mesh_points',
                stage_identifier + '_stage_mesh_lines',
                stage_identifier + '_stage_mesh_line_strip',
                stage_identifier + '_stage_mesh_line_loop',
                stage_identifier + '_stage_mesh_triangles',
                stage_identifier + '_stage_mesh_triangle_fan',
                stage_identifier + '_stage_mesh_triangle_strip'],
                    (function (stage_identifier) {
                        return function () {
                            if ($("#" + stage_identifier + '_stage_shader').prop("checked")) {
                                $("#" + stage_identifier + "_indices_section").hide();
                                $("#" + stage_identifier + "_vertices_section").hide();
                            }
                            else {
                                $("#" + stage_identifier + "_indices_section").show();
                                $("#" + stage_identifier + "_vertices_section").show();
                            }
                        }
                    })(stage_identifier));

                indices_editor = CodeMirror.fromTextArea(document.getElementById(stage_identifier + '_indices_code'), { autoRefresh: true, lineWrapping: true, lineNumbers: true, viewPortMargin: Infinity, theme: 'the-matrix height-auto', mode: 'javascript' });
                indices_editor.getWrapperElement().id = stage_identifier + '_indices_code_editor';
                indices_editor.setValue(stage.indices ? stage.indices : "");
                this.stage_codemirrors[i].push(indices_editor);

                vertices_editor = CodeMirror.fromTextArea(document.getElementById(stage_identifier + '_vertices_code'), { autoRefresh: true, lineWrapping: true, lineNumbers: true, viewPortMargin: Infinity, theme: 'the-matrix height-auto', mode: 'javascript' });
                vertices_editor.getWrapperElement().id = stage_identifier + '_vertices_code_editor';
                vertices_editor.setValue(stage.vertices ? stage.vertices : "");
                this.stage_codemirrors[i].push(vertices_editor);

                if (stage.type == OpenGLStage.Type.SHADER)
                    $("#" + stage_identifier + '_stage_shader').prop("checked", false).click();
                if (stage.type == OpenGLStage.Type.MESH_POINTS)
                    $("#" + stage_identifier + '_stage_mesh_points').prop("checked", false).click();
                if (stage.type == OpenGLStage.Type.MESH_LINES)
                    $("#" + stage_identifier + '_stage_mesh_lines').prop("checked", false).click();
                if (stage.type == OpenGLStage.Type.MESH_LINE_STRIP)
                    $("#" + stage_identifier + '_stage_mesh_line_strip').prop("checked", false).click();
                if (stage.type == OpenGLStage.Type.MESH_LINE_LOOP)
                    $("#" + stage_identifier + '_stage_mesh_line_loop').prop("checked", false).click();
                if (stage.type == OpenGLStage.Type.MESH_TRIANGLES)
                    $("#" + stage_identifier + '_stage_mesh_triangles').prop("checked", false).click();
                if (stage.type == OpenGLStage.Type.MESH_TRIANGLE_FAN)
                    $("#" + stage_identifier + '_stage_mesh_triangle_fan').prop("checked", false).click();
                if (stage.type == OpenGLStage.Type.MESH_TRIANGLE_STRIP)
                    $("#" + stage_identifier + '_stage_mesh_triangle_strip').prop("checked", false).click();
            }
        }
        GlobalState.prototype.get_ui_algorithm = function () {

            var ui_algorithm = {
                name: $(window.location.hash + "_algorithm_title").val(),
                public: $(window.location.hash + "_algorithm_public_checkbox").prop("checked") ? true : false,
                type: Message.Type.ALGORITHM,
                state: {
                    html: $(window.location.hash + "_algorithm_html_checkbox").prop("checked") ? true : false,
                    client: $(window.location.hash + "_algorithm_javascript_checkbox").prop("checked") ? true : false,
                    server: false
                },
                html: window.location.hash == pages.EDIT ? window.edit_html_editor.getValue() : window.create_html_editor.getValue(),
                client: window.location.hash == pages.EDIT ? window.edit_javascript_editor.getValue() : window.create_javascript_editor.getValue(),
                pipeline: {
                    contexts: this.get_ui_contexts(),
                    programs: this.get_ui_programs(),
                    stages: this.get_ui_stages()
                }
            };

            return ui_algorithm;
        }

        GlobalState.prototype.set_ui_algorithm = function (algorithm) {
            algorithm = AlgorithmMessage.fromObject(algorithm);
            algorithm.pipeline.contexts = !algorithm.pipeline.contexts ? [] : algorithm.pipeline.contexts;
            algorithm.pipeline.programs = !algorithm.pipeline.programs ? [] : algorithm.pipeline.programs;
            algorithm.pipeline.stages = !algorithm.pipeline.stages ? [] : algorithm.pipeline.stages;

            this.destroy_editors();
            this.refresh_static_editors();

            $(window.location.hash + "_algorithm_title").val(algorithm.name);
            $(window.location.hash + "_algorithm_description").val(algorithm.description);

            if (algorithm.public)
                $(window.location.hash + "_algorithm_public_checkbox").prop("checked", false).click();
            else
                $(window.location.hash + "_algorithm_public_checkbox").prop("checked", false).click();

            if (algorithm.state.html) {
                $(window.location.hash + "_algorithm_html_checkbox").prop("checked", false).click();
                $(window.location.hash + "_algorithm_html").show();
                if (window.location.hash == pages.EDIT) {
                    window.edit_html_editor.setValue(algorithm.html)

                }
                else if (window.location.hash == pages.CREATE) {
                    window.create_html_editor.setValue(algorithm.html)
                }
            }
            else {
                $(window.location.hash + "_algorithm_html").hide();
            }

            if (algorithm.state.client) {
                $(window.location.hash + "_algorithm_javascript_checkbox").prop("checked", false).click();
                $(window.location.hash + "_algorithm_javascript").show();
                if (window.location.hash == pages.EDIT) {
                    window.edit_javascript_editor.setValue(algorithm.client)
                }
                else if (window.location.hash == pages.CREATE) {
                    window.create_javascript_editor.setValue(algorithm.client)
                }
            }
            else {
                $(window.location.hash + "_algorithm_javascript").hide();
            }

            this.pipeline.contexts = [];
            this.pipeline.programs = [];
            this.pipeline.stages = [];

            $(window.location.hash + "_algorithm_contexts").html("");
            $(window.location.hash + "_algorithm_programs").html("");
            $(window.location.hash + "_algorithm_stages").html("");

            for (var i = 0; i < algorithm.pipeline.contexts.length; i++)
                this.add_context(algorithm.pipeline.contexts[i]);
            for (var i = 0; i < algorithm.pipeline.programs.length; i++)
                this.add_program(algorithm.pipeline.programs[i]);
            for (var i = 0; i < algorithm.pipeline.stages.length; i++)
                this.add_stage(algorithm.pipeline.stages[i]);

            this.refresh_codemirrors();
        }
        GlobalState.prototype.refresh_codemirrors = function () {
            for (var i = 0; i < this.context_codemirrors.length; i++) {
                this.context_codemirrors[i].refresh();
                // this.context_codemirrors[i].getWrapperElement().onmouseenter = function (i) { this.context_codemirrors[i].refresh() }.bind(this, [i]);
            }
            for (var i = 0; i < this.program_codemirrors.length; i++)
                for (var j = 0; j < this.program_codemirrors[i].length; j++) {
                    this.program_codemirrors[i][j].refresh();
                    // this.program_codemirrors[i][j].getWrapperElement().onmouseenter = function (i) { this.program_codemirrors[i][j].refresh() }.bind(this, [i]);
                }
            for (var i = 0; i < this.stage_codemirrors.length; i++)
                for (var j = 0; j < this.stage_codemirrors[i].length; j++) {
                    this.stage_codemirrors[i][j].refresh();;
                    // this.stage_codemirrors[i][j].getWrapperElement().onmouseenter = function (i) { this.stage_codemirrors[i][j].refresh() }.bind(this, [i]);
                }

            window.edit_html_editor.refresh();
            window.edit_javascript_editor.refresh();
            window.create_html_editor.refresh();
            window.create_javascript_editor.refresh();

            // window.edit_html_editor.getWrapperElement().onmouseenter = function () { window.edit_html_editor.refresh() }
            // window.edit_javascript_editor.getWrapperElement().onmouseenter = function () { window.edit_javascript_editor.refresh() }
            // window.create_html_editor.getWrapperElement().onmouseenter = function () { window.create_html_editor.refresh() }
            // window.create_javascript_editor.getWrapperElement().onmouseenter = function () { window.create_javascript_editor.refresh() }
        }

        GlobalState.prototype.destroy_editors = function (name) {

            window.edit_html_editor.toTextArea();
            $(window.edit_html_editor.getTextArea()).hide();
            window.edit_javascript_editor.toTextArea();
            $(window.edit_javascript_editor.getTextArea()).hide();
            window.create_html_editor.toTextArea();
            $(window.create_html_editor.getTextArea()).hide();
            window.create_javascript_editor.toTextArea();
            $(window.create_javascript_editor.getTextArea()).hide();

            for (var i = 0; i < this.context_codemirrors.length; i++)
                this.context_codemirrors[i].toTextArea();
            for (var i = 0; i < this.context_codemirrors.length; i++)
                $(this.context_codemirrors[i].getTextArea()).remove();

            for (var i = 0; i < this.program_codemirrors.length; i++)
                for (var j = 0; j < this.program_codemirrors[i].length; j++)
                    this.program_codemirrors[i][j].toTextArea();
            for (var i = 0; i < this.program_codemirrors.length; i++)
                for (var j = 0; j < this.program_codemirrors[i].length; j++)
                    $(this.program_codemirrors[i][j].getTextArea()).remove();

            for (var i = 0; i < this.stage_codemirrors.length; i++)
                for (var j = 0; j < this.stage_codemirrors[i].length; j++)
                    this.stage_codemirrors[i][j].toTextArea();
            for (var i = 0; i < this.stage_codemirrors.length; i++)
                for (var j = 0; j < this.stage_codemirrors[i].length; j++)
                    $(this.stage_codemirrors[i][j].getTextArea()).remove();
        }

        GlobalState.prototype.refresh_static_editors = function (name) {
            window.edit_html_editor = CodeMirror.fromTextArea(document.getElementById("edit_algorithm_html_textarea"), { autoRefresh: true, lineWrapping: true, lineNumbers: true, viewPortMargin: Infinity, theme: 'the-matrix height-auto', mode: 'xml' });
            window.edit_javascript_editor = CodeMirror.fromTextArea(document.getElementById("edit_algorithm_javascript_textarea"), { autoRefresh: true, lineWrapping: true, lineNumbers: true, viewPortMargin: Infinity, theme: 'the-matrix height-auto', mode: 'javascript' })
            window.create_html_editor = CodeMirror.fromTextArea(document.getElementById("create_algorithm_html_textarea"), { autoRefresh: true, lineWrapping: true, lineNumbers: true, viewPortMargin: Infinity, theme: 'the-matrix height-auto', mode: 'xml' });
            window.create_javascript_editor = CodeMirror.fromTextArea(document.getElementById("create_algorithm_javascript_textarea"), { autoRefresh: true, lineWrapping: true, lineNumbers: true, viewPortMargin: Infinity, theme: 'the-matrix height-auto', mode: 'javascript' });
        }

        GlobalState.prototype.fork_algorithm = function (name) {
            var algorithm = name.toLowerCase().replace(/ /g, "_");
            var new_url = window.location.protocol + "//" + window.location.host + window.location.pathname + "?algorithm=" + algorithm + "&fork=" + algorithm + pages.CREATE;;
            window.history.replaceState({}, document.title, new_url);
            document.getElementById(window.location.hash.substring(1) + "_button").click();
            this.refresh_content(window.location.hash);
        }
        GlobalState.prototype.goto_algorithm_preview = function (name) {
            var new_url = window.location.protocol + "//" + window.location.host + "/canvas.html" + "?algorithm=" + name;
            window.open(new_url);
        }
        GlobalState.prototype.save_algorithm = function () {
            if (!this.logged_in)
                this.show_page(pages.CLIENT_ERROR, "Invalid credentials!", "Please log in or create an account first!", true)
            else {
                this.show_page(pages.PROCESSING, "Saving algorithm.", "Please wait...", false);
                this.preview_iframe = document.getElementById(window.location.hash.substring(1) + "_preview_iframe");
                this.preview_iframe.contentWindow.postMessage(JSON.stringify({ save_algorithm: true }), '*');
            }
        }
        function download(filename, text) {
            var element = document.createElement('a');
            element.setAttribute('href', 'data:text/plain;charset=utf-8,' + encodeURIComponent(text));
            element.setAttribute('download', filename);
            element.style.display = 'none';
            document.body.appendChild(element);
            element.click();
            document.body.removeChild(element);
        }

        GlobalState.prototype.download_algorithm = function () {
            var algorithm = this.get_ui_algorithm();
            this.show_page(pages.PROCESSING, "Downloading algorithm \"" + algorithm.name + "\"...", "Please wait...", false);
            var new_url = window.location.protocol + "//" + window.location.host + "/canvas.html";
            fetch(new_url)
                .then(function (algorithm) {
                    return function (response) {
                        response.text().then(function (val) {
                            this.hide_popovers();
                            this.show_page(pages.PROCESSING, "Download complete!", "Enjoy!", true);
                            download(algorithm.name + ".html", val.replace(/\/\/ALGORITHM_INSERTION_POINT/, "handle_event({proto:" + JSON.stringify(algorithm) + "})"));
                        }.bind(this))
                            .catch(function (err) {
                                this.show_page(pages.CLIENT_ERROR, "Failed to generate template algorithm!", "Please try a another way!", true)
                            }.bind(this));
                    }.bind(this)
                }.bind(this)(algorithm))
        }
        function cleanQuery(obj) {
            var newobj = {};
            if (!obj)
                return newobj;

            if (obj.viewsPriority)
                newobj.viewsPriority = obj.viewsPriority;

            if (obj.votesPriority)
                newobj.votesPriority = obj.votesPriority;

            if (obj.createdPriority)
                newobj.createdPriority = obj.createdPriority;

            if (obj.editedPriority)
                newobj.editedPriority = obj.editedPriority;

            if (obj.page)
                newobj.page = obj.page;

            if (obj.count)
                newobj.count = obj.count;
            if (obj.total)
                newobj.total = obj.total;

            if (obj.description)
                newobj.description = obj.description;

            return newobj;
        }

        GlobalState.prototype.sortViews = function () {
            this.coming_soon();
        }
        GlobalState.prototype.sortVotes = function () {
            this.coming_soon();

        }
        GlobalState.prototype.sortCreated = function () {
            this.coming_soon();
        }
        GlobalState.prototype.sortEdited = function () {
            this.coming_soon();
        }
        GlobalState.prototype.search = function () {
            this.coming_soon();
        }
        GlobalState.prototype.firstPage = function () {
            this.coming_soon();
        }
        GlobalState.prototype.previousPage = function () {
            this.coming_soon();
        }
        GlobalState.prototype.nextPage = function () {
            this.coming_soon();
        }
        GlobalState.prototype.lastPage = function () {
            this.coming_soon();
        }
        GlobalState.prototype.love = function () {
            this.coming_soon();
        }
        GlobalState.prototype.hate = function () {
            this.coming_soon();
        }

        GlobalState.prototype.browse_edit = function (name) {
            setQueryVariable("algorithm", name.toLowerCase().replace(/ /g, "_"));
            state.show_page(pages.EDIT);
        }
        GlobalState.prototype.browse_fork = function (name) {
            setQueryVariable("fork", name.toLowerCase().replace(/ /g, "_"));
            state.show_page(pages.CREATE);
        }
        GlobalState.prototype.browse_preview = function (name) {
            this.goto_algorithm_preview(name.toLowerCase().replace(/ /g, "_"));
        }

        GlobalState.prototype.browse_download = function (name) {
            this.show_page(pages.PROCESSING, "Downloading algorithm \"" + name + "\"...", "Please wait...", false);
            name = name.toLowerCase().replace(/ /g, "_");
            var new_url = window.location.protocol + "//" + window.location.host + "/canvas.html?algorithm=" + name;
            fetch(new_url)
                .then(function (response) {
                    response.text().then(function (val) {
                        this.hide_popovers();
                        this.show_page(pages.PROCESSING, "Download complete!", "Enjoy!", true);
                        download(name + ".html", val);
                    }.bind(this))
                        .catch(function (err) {
                            this.hide_popovers();
                            this.show_page(pages.CLIENT_ERROR, "Failed to generate template algorithm!", "Please try a another way!", true)
                        }.bind(this));
                }.bind(this))
        }
        state = new GlobalState();


        window.addEventListener("message", function (event) {
            // Do we trust the sender of this message?  (might be
            // different from what we originally opened, for example).
            if (event.origin.toLowerCase() != "https://www.crazedcoding.com")
                return;
            try {
                var message = JSON.parse(event.data);

                if (message.fetch_algorithm) {
                    if (window.location.hash == pages.CREATE)
                        message.proto.name = "Fork of " + message.proto.name;
                    this.set_ui_algorithm(message.proto);
                    $('.loading-indicator').hide();
                    this.hide_popovers();
                }
                if (message.save_algorithm) {
                    this.send(Message.encode({
                        type: Message.Type.SAVE_ALGORITHM,
                        auth: {
                            user: this.user_name,
                            hash: this.hash
                        },
                        algorithm: AlgorithmMessage.fromObject(message.proto)
                    }).finish(), true)
                }
            }
            catch (e) {
                console.log(e);
            }

            // event.source is popup
            // event.data is "hi there yourself!  the secret response is: rheeeeet!"
        }.bind(state), false);

        window.onload = on_resources_loaded;
    </script>
</body>

</html>